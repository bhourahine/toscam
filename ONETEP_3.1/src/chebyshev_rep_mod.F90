! -*- mode: F90 ; mode: font-lock ; column-number-mode: true -*-
!-----------------------------------------------------------------------!
!                                                                       !
! Chebyshev representation module                                       !
!                                                                       !
! Written by Jacek Dziedzic in January 2012                             !
!                                                                       !
!-----------------------------------------------------------------------!
!                                                                       !
! This module implements expansion of functions into Chebyshev          !
! polynomials. The expansions can then be easily and efficiently        !
! integrated. This is especially handy for integrals of products --     !
! in order to obtain \int f1_i(x) f2_j(x) dx for i=1..M, j=1..N,        !
! it suffices to expand f1_i(x) for i=1..M and f2_j(x) for j=1..N       !
! (at a cost of O(M+N)), followed by integrating the product of the     !
! expansions, which, although still O(M*N), has a much smaller prefactor!
! as products of Chebyshev polynomials can be accurately and efficiently!
! integrated.                                                           !
!                                                                       !
! The module currently implements this for 1D integrals and for         !
! 3D integrals over a sphere. The expansion is performed on a given     !
! number of interval to prevent Runge's phenomenon that plagues         !
! high-order expansions. Thus it is possible to expand a function over, !
! say, 10 intervals with 8th order Chebyshev polynomials.               !
!                                                                       !
!-----------------------------------------------------------------------!


module chebyshev_rep

  use constants, only: DP
  use utils, only: utils_trace_in, utils_trace_out

  implicit none
  private

  ! Public types
  public :: SPHERE_NODES
  public :: SPHERE_COEFFS
  public :: HANDLE_SET

  ! Public subroutines

  ! --- single-interval, 1D expansion ---
  public :: cheb_gen_nodes_1D
  public :: cheb_expansion_1D
  public :: cheb_int_1D
  public :: cheb_int_product_1D

  ! --- many-interval (piecewise), 1D expansion ---
  public :: cheb_gen_nodes_piecewise_1D
  public :: cheb_expansion_piecewise_1D
  public :: cheb_int_piecewise_1D
  public :: cheb_int_product_piecewise_1D

  ! --- 3D expansion over a sphere ---
  public :: cheb_gen_nodes_for_sphere
  public :: cheb_expansion_for_sphere
  public :: cheb_int_sphere
  public :: cheb_int_product_sphere

  ! --- Allocation and deallocation of coefficients ---
  public :: cheb_alloc_coeffs
  public :: cheb_dealloc_coeffs

  ! --- Interprocessor communication of coefficients ---
  public :: cheb_send_coeffs_initiate
  public :: cheb_recv_coeffs_initiate
  public :: cheb_test_completion

  ! ---------------------------------------------------------------------------

  ! Stores ranges of component integrals in a 3D sphere expansion
  type SPHERE_RANGES
     integer :: n_stripes
     real(kind=DP) :: zmin
     real(kind=DP) :: zmax
     real(kind=DP), allocatable :: ymin(:)
     real(kind=DP), allocatable :: ymax(:)
     real(kind=DP), allocatable :: xmin(:,:)
     real(kind=DP), allocatable :: xmax(:,:)
  end type SPHERE_RANGES

  ! Stores Chebyshev nodes in a 3D sphere expansion
  type SPHERE_NODES
     integer :: n_points_total
     type(SPHERE_RANGES) :: sph_ranges
     real(kind=DP), allocatable :: znodes(:)
     real(kind=DP), allocatable :: ynodes(:,:)
     real(kind=DP), allocatable :: xnodes(:,:,:)
  end type SPHERE_NODES

  ! Stores Chebyshev expansion coefficients for a 3D sphere expansion
  ! NB, any additions to this structure require updates to
  !     cheb_send_coeffs_initiate and cheb_recv_coeffs_initiate, and updating
  !     n_variables_in_sphere_coeffs
  type SPHERE_COEFFS
     integer :: n_intervals
     integer :: order
     real(kind=DP), allocatable :: zcoeffs(:)
     real(kind=DP), allocatable :: ycoeffs(:,:)    ! currently unused
     real(kind=DP), allocatable :: xcoeffs(:,:,:)  ! currently unused
  end type SPHERE_COEFFS
  integer, parameter :: n_variables_in_sphere_coeffs = 5

  ! An opaque type for testing for completion of cheb_*_coeffs_initiate
  type HANDLE_SET
     integer :: handles(1:n_variables_in_sphere_coeffs)
  end type

  integer, parameter :: CHEB_ELEMENT_TAG = 900 ! Internal
  
  integer, parameter :: max_cheb_order = 40
  real(kind=DP) :: cheb_integrals(max_cheb_order)

  ! Table of integrals of (ChebyshevT[n,1] - ChebyshevT[n,-1])
  DATA cheb_integrals(:) / &
       2.0000000000000000000000000_DP,   0.0_DP, &
      -0.6666666666666666666666667,      0.0_DP, &
      -0.13333333333333333333333333_DP,  0.0_DP, &
      -0.05714285714285714285714286,     0.0_DP, &
      -0.03174603174603174603174603_DP,  0.0_DP, &
      -0.02020202020202020202020202,     0.0_DP, &
      -0.01398601398601398601398601_DP,  0.0_DP, &
      -0.01025641025641025641025641,     0.0_DP, &
      -0.007843137254901960784313725_DP, 0.0_DP, &
      -0.006191950464396284829721362,    0.0_DP, &
      -0.005012531328320802005012531_DP, 0.0_DP, &
      -0.004140786749482401656314700,    0.0_DP, &
      -0.003478260869565217391304348_DP, 0.0_DP, &
      -0.002962962962962962962962963,    0.0_DP, &
      -0.002554278416347381864623244_DP, 0.0_DP, &
      -0.002224694104560622914349277,    0.0_DP, &
      -0.001955034213098729227761486_DP, 0.0_DP, &
      -0.001731601731601731601731602,    0.0_DP, &
      -0.001544401544401544401544402_DP, 0.0_DP, &
      -0.001386001386001386001386001,    0.0_DP /

  ! jd: Let I_nm(x) = \int ChebyshevT[n,x] * ChebyshevT[m,x] dx
  !     The following is a table of I_nm(1) - I_nm(-1) for all n, m in [1, 40].
  !
  !     There are 35 digits of precision in case these subroutines are ever
  !     ported to quad precision.
  !
  !     It can be obtained by first running the following code in Mathematica
  !
  !  IntOfChebyshevT[n_, xx_] := ChebIntegralTable[[n + 1]] /. x -> xx
  !  IntOfChebyshevTProduct[n_, m_, xx_] := 
  !       ChebProductIntegralTable[[n + 1]][[m + 1]] /. x -> xx
  !  tabmax = 40;
  !  ChebIntegralTable = {};
  !  ChebProductIntegralTable = Table[I, {i, 1, tabmax}, {j, 1, tabmax}];
  !  IntOfChebyshevTProductLookup = 
  !       Table[I, {i, 1, tabmax}, {j, 1, tabmax}];
  !  For[n = 0, n < tabmax,
  !    AppendTo[ChebIntegralTable, Integrate[ChebyshevT[n, x], x]];
  !    AppendTo[ChebSquaredIntegralTable, 
  !         Integrate[ChebyshevT[n, x]^2, x]];
  !    For[m = 0, m < tabmax,
  !      ChebProductIntegralTable[[n + 1]][[m + 1]] = 
  !           Integrate[ChebyshevT[n, x]*ChebyshevT[m, x], x];
  !      IntOfChebyshevTProductLookup[[n + 1]][[m + 1]] = 
  !           IntOfChebyshevTProduct[n,m,1] - IntOfChebyshevTProduct[n,m,-1]; 
  !      m++;
  !    ];
  !    n++;
  !  ]
  !
  ! The output should then be saved to coeffs.txt and parsed with
  !
  ! cat coeffs.txt | sed -e "s/}}/_DP/" -e "s/{//g" -e "s/}//g" -e "s/,/_DP/g" \
  !                      -e "s/ _DP//" -e "s/\\\\//g" -e "s/_DP/_DP, /g" \
  !                | tr "," "\n" | grep DP | sed -r "s/^[ \t]*//" \
  !                | sed -r "s/^0_DP/0.0_DP/g" | sed "s/_DP/_DP, \&/g"
  real(kind=DP) :: cheb_product_integrals(max_cheb_order, max_cheb_order)

  DATA cheb_product_integrals(:,:) / &
       2.0000000000000000000000000000000000_DP, &
       0.0_DP, &
       -0.66666666666666666666666666666666667_DP, &
       0.0_DP, &
       -0.13333333333333333333333333333333333_DP, &
       0.0_DP, &
       -0.057142857142857142857142857142857143_DP, &
       0.0_DP, &
       -0.031746031746031746031746031746031746_DP, &
       0.0_DP, &
       -0.020202020202020202020202020202020202_DP, &
       0.0_DP, &
       -0.013986013986013986013986013986013986_DP, &
       0.0_DP, &
       -0.010256410256410256410256410256410256_DP, &
       0.0_DP, &
       -0.0078431372549019607843137254901960784_DP, &
       0.0_DP, &
       -0.0061919504643962848297213622291021672_DP, &
       0.0_DP, &
       -0.0050125313283208020050125313283208020_DP, &
       0.0_DP, &
       -0.0041407867494824016563146997929606625_DP, &
       0.0_DP, &
       -0.0034782608695652173913043478260869565_DP, &
       0.0_DP, &
       -0.0029629629629629629629629629629629630_DP, &
       0.0_DP, &
       -0.0025542784163473818646232439335887612_DP, &
       0.0_DP, &
       -0.0022246941045606229143492769744160178_DP, &
       0.0_DP, &
       -0.0019550342130987292277614858260019550_DP, &
       0.0_DP, &
       -0.0017316017316017316017316017316017316_DP, &
       0.0_DP, &
       -0.0015444015444015444015444015444015444_DP, &
       0.0_DP, &
       -0.0013860013860013860013860013860013860_DP, &
       0.0_DP, &
       0.0_DP, &
       0.66666666666666666666666666666666667_DP, &
       0.0_DP, &
       -0.40000000000000000000000000000000000_DP, &
       0.0_DP, &
       -0.095238095238095238095238095238095238_DP, &
       0.0_DP, &
       -0.044444444444444444444444444444444444_DP, &
       0.0_DP, &
       -0.025974025974025974025974025974025974_DP, &
       0.0_DP, &
       -0.017094017094017094017094017094017094_DP, &
       0.0_DP, &
       -0.012121212121212121212121212121212121_DP, &
       0.0_DP, &
       -0.0090497737556561085972850678733031674_DP, &
       0.0_DP, &
       -0.0070175438596491228070175438596491228_DP, &
       0.0_DP, &
       -0.0056022408963585434173669467787114846_DP, &
       0.0_DP, &
       -0.0045766590389016018306636155606407323_DP, &
       0.0_DP, &
       -0.0038095238095238095238095238095238095_DP, &
       0.0_DP, &
       -0.0032206119162640901771336553945249597_DP, &
       0.0_DP, &
       -0.0027586206896551724137931034482758621_DP, &
       0.0_DP, &
       -0.0023894862604540023894862604540023895_DP, &
       0.0_DP, &
       -0.0020898641588296760710553814002089864_DP, &
       0.0_DP, &
       -0.0018433179723502304147465437788018433_DP, &
       0.0_DP, &
       -0.0016380016380016380016380016380016380_DP, &
       0.0_DP, &
       -0.0014652014652014652014652014652014652_DP, &
       0.0_DP, &
       -0.0013183915622940013183915622940013184_DP, &
       -0.66666666666666666666666666666666667_DP, &
       0.0_DP, &
       0.93333333333333333333333333333333333_DP, &
       0.0_DP, &
       -0.36190476190476190476190476190476190_DP, &
       0.0_DP, &
       -0.082539682539682539682539682539682540_DP, &
       0.0_DP, &
       -0.038672438672438672438672438672438672_DP, &
       0.0_DP, &
       -0.022866022866022866022866022866022866_DP, &
       0.0_DP, &
       -0.015229215229215229215229215229215229_DP, &
       0.0_DP, &
       -0.010914575620457973399149869738105032_DP, &
       0.0_DP, &
       -0.0082241803604032706199888862427562118_DP, &
       0.0_DP, &
       -0.0064278342916113813946631284092584402_DP, &
       0.0_DP, &
       -0.0051663686069393432430180310110314149_DP, &
       0.0_DP, &
       -0.0042453960989430096981584395772038793_DP, &
       0.0_DP, &
       -0.0035518748562226823096388313779618127_DP, &
       0.0_DP, &
       -0.0030162696429562996279637958798378588_DP, &
       0.0_DP, &
       -0.0025938285337617929386561199686894904_DP, &
       0.0_DP, &
       -0.0022546563147230555461923648797953581_DP, &
       0.0_DP, &
       -0.0019781479180811772580404393530088747_DP, &
       0.0_DP, &
       -0.0017497178787501368146529436852017497_DP, &
       0.0_DP, &
       -0.0015588015588015588015588015588015588_DP, &
       0.0_DP, &
       -0.0013975916414940805184707623732013976_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.40000000000000000000000000000000000_DP, &
       0.0_DP, &
       0.97142857142857142857142857142857143_DP, &
       0.0_DP, &
       -0.34920634920634920634920634920634921_DP, &
       0.0_DP, &
       -0.076767676767676767676767676767676768_DP, &
       0.0_DP, &
       -0.035564435564435564435564435564435564_DP, &
       0.0_DP, &
       -0.021001221001221001221001221001221001_DP, &
       0.0_DP, &
       -0.014022578728461081402257872846108140_DP, &
       0.0_DP, &
       -0.010088982225205135421853688107558077_DP, &
       0.0_DP, &
       -0.0076344707923655292076344707923655292_DP, &
       0.0_DP, &
       -0.0059919620021921812203142126415783705_DP, &
       0.0_DP, &
       -0.0048351056669807511105128550275945619_DP, &
       0.0_DP, &
       -0.0039877471456418824839877471456418825_DP, &
       0.0_DP, &
       -0.0033475325829148917604689718632747119_DP, &
       0.0_DP, &
       -0.0028514774870629201528268124002514872_DP, &
       0.0_DP, &
       -0.0024589985880308460953622243944824590_DP, &
       0.0_DP, &
       -0.0021429400739745567331774228325952464_DP, &
       0.0_DP, &
       -0.0018845478244810836579468392594087811_DP, &
       0.0_DP, &
       -0.0016705177995500576145737436060016705_DP, &
       0.0_DP, &
       -0.0014911917350941741185643624668014912_DP, &
       0.0_DP, &
       -0.0013394157466760983493825240847362231_DP, &
       -0.13333333333333333333333333333333333_DP, &
       0.0_DP, &
       -0.36190476190476190476190476190476190_DP, &
       0.0_DP, &
       0.98412698412698412698412698412698413_DP, &
       0.0_DP, &
       -0.34343434343434343434343434343434343_DP, &
       0.0_DP, &
       -0.073659673659673659673659673659673660_DP, &
       0.0_DP, &
       -0.033699633699633699633699633699633700_DP, &
       0.0_DP, &
       -0.019794584500466853408029878618113912_DP, &
       0.0_DP, &
       -0.013196985333208243424961691215561185_DP, &
       0.0_DP, &
       -0.0094992726571673940094992726571673940_DP, &
       0.0_DP, &
       -0.0071985985029463290332855550246854595_DP, &
       0.0_DP, &
       -0.0056606990622335890878090366581415175_DP, &
       0.0_DP, &
       -0.0045774567136796238963421625960325651_DP, &
       0.0_DP, &
       -0.0037834048723340919348178876309547816_DP, &
       0.0_DP, &
       -0.0031827404270215122853319883836883402_DP, &
       0.0_DP, &
       -0.0027166475413319733095329168260444558_DP, &
       0.0_DP, &
       -0.0023472823472823472823472823472823473_DP, &
       0.0_DP, &
       -0.0020493399803744631330838227389951528_DP, &
       0.0_DP, &
       -0.0018053477452810044578676391802087019_DP, &
       0.0_DP, &
       -0.0016029079758426729315793045140016029_DP, &
       0.0_DP, &
       -0.0014330158402761919494761241783363167_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.095238095238095238095238095238095238_DP, &
       0.0_DP, &
       -0.34920634920634920634920634920634921_DP, &
       0.0_DP, &
       0.98989898989898989898989898989898990_DP, &
       0.0_DP, &
       -0.34032634032634032634032634032634033_DP, &
       0.0_DP, &
       -0.071794871794871794871794871794871795_DP, &
       0.0_DP, &
       -0.032492997198879551820728291316526611_DP, &
       0.0_DP, &
       -0.018968991105214015430733696987566957_DP, &
       0.0_DP, &
       -0.012607275765170502012607275765170502_DP, &
       0.0_DP, &
       -0.0090634003677481938351503568894873243_DP, &
       0.0_DP, &
       -0.0068673355629877369007803790412486065_DP, &
       0.0_DP, &
       -0.0054030501089324618736383442265795207_DP, &
       0.0_DP, &
       -0.0043731144403718333471723030813454642_DP, &
       0.0_DP, &
       -0.0036186127164407124596809041513684099_DP, &
       0.0_DP, &
       -0.0030479104812905654420380928094813088_DP, &
       0.0_DP, &
       -0.0026049313005834744965179747788443441_DP, &
       0.0_DP, &
       -0.0022536822536822536822536822536822537_DP, &
       0.0_DP, &
       -0.0019701399011743839330046226597950736_DP, &
       0.0_DP, &
       -0.0017377379215736197748732000882086343_DP, &
       0.0_DP, &
       -0.0015447320810246907624910662255364285_DP, &
       0.0_DP, &
       -0.0013825967314339407362663176616664989_DP, &
       -0.057142857142857142857142857142857143_DP, &
       0.0_DP, &
       -0.082539682539682539682539682539682540_DP, &
       0.0_DP, &
       -0.34343434343434343434343434343434343_DP, &
       0.0_DP, &
       0.99300699300699300699300699300699301_DP, &
       0.0_DP, &
       -0.33846153846153846153846153846153846_DP, &
       0.0_DP, &
       -0.070588235294117647058823529411764706_DP, &
       0.0_DP, &
       -0.031667403803626713843432109685979655_DP, &
       0.0_DP, &
       -0.018379281537176274018379281537176274_DP, &
       0.0_DP, &
       -0.012171403475751301838258359997490432_DP, &
       0.0_DP, &
       -0.0087321374277896017026451809060504713_DP, &
       0.0_DP, &
       -0.0066096866096866096866096866096866097_DP, &
       0.0_DP, &
       -0.0051987078356246713244684847118924198_DP, &
       0.0_DP, &
       -0.0042083222844784538720353196017590925_DP, &
       0.0_DP, &
       -0.0034837827707097656163870085771613785_DP, &
       0.0_DP, &
       -0.0029361942405420666290231507622811971_DP, &
       0.0_DP, &
       -0.0025113312069833808964243746852442505_DP, &
       0.0_DP, &
       -0.0021744821744821744821744821744821745_DP, &
       0.0_DP, &
       -0.0019025300774669992500101835677950060_DP, &
       0.0_DP, &
       -0.0016795620267556376057849617997434598_DP, &
       0.0_DP, &
       -0.0014943129721824395492812597088666106_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.044444444444444444444444444444444444_DP, &
       0.0_DP, &
       -0.076767676767676767676767676767676768_DP, &
       0.0_DP, &
       -0.34032634032634032634032634032634033_DP, &
       0.0_DP, &
       0.99487179487179487179487179487179487_DP, &
       0.0_DP, &
       -0.33725490196078431372549019607843137_DP, &
       0.0_DP, &
       -0.069762641898864809081527347781217750_DP, &
       0.0_DP, &
       -0.031077694235588972431077694235588972_DP, &
       0.0_DP, &
       -0.017943409247757073844030365769496204_DP, &
       0.0_DP, &
       -0.011840140535792709705753184014053579_DP, &
       0.0_DP, &
       -0.0084744884744884744884744884744884745_DP, &
       0.0_DP, &
       -0.0064053443363788191374398270949995088_DP, &
       0.0_DP, &
       -0.0050339156797312918493315012323060481_DP, &
       0.0_DP, &
       -0.0040734923387475070287414240275520611_DP, &
       0.0_DP, &
       -0.0033720665299612668033720665299612668_DP, &
       0.0_DP, &
       -0.0028425941469419730289295506686811035_DP, &
       0.0_DP, &
       -0.0024321311277833016963451746060441713_DP, &
       0.0_DP, &
       -0.0021068723507747897991800430824821069_DP, &
       0.0_DP, &
       -0.0018443541826490170809219452793298315_DP, &
       0.0_DP, &
       -0.0016291429179133863925751552830736420_DP, &
       0.0_DP, &
       -0.0014503303453200501930769604070908120_DP, &
       -0.031746031746031746031746031746031746_DP, &
       0.0_DP, &
       -0.038672438672438672438672438672438672_DP, &
       0.0_DP, &
       -0.073659673659673659673659673659673660_DP, &
       0.0_DP, &
       -0.33846153846153846153846153846153846_DP, &
       0.0_DP, &
       0.99607843137254901960784313725490196_DP, &
       0.0_DP, &
       -0.33642930856553147574819401444788442_DP, &
       0.0_DP, &
       -0.069172932330827067669172932330827068_DP, &
       0.0_DP, &
       -0.030641821946169772256728778467908903_DP, &
       0.0_DP, &
       -0.017612146307798481711525189786059351_DP, &
       0.0_DP, &
       -0.011582491582491582491582491582491582_DP, &
       0.0_DP, &
       -0.0082701462011806839393046289598013736_DP, &
       0.0_DP, &
       -0.0062405521804854396623028436154131371_DP, &
       0.0_DP, &
       -0.0048990857340003450060376056580990167_DP, &
       0.0_DP, &
       -0.0039617760979990082157264819803519494_DP, &
       0.0_DP, &
       -0.0032784664363611732032784664363611732_DP, &
       0.0_DP, &
       -0.0027633940677418938288503505894810243_DP, &
       0.0_DP, &
       -0.0023645213040759170133507355140441037_DP, &
       0.0_DP, &
       -0.0020486964559568076300918047940169324_DP, &
       0.0_DP, &
       -0.0017939350738067658677121387626600137_DP, &
       0.0_DP, &
       -0.0015851602910509970363708559812978434_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.025974025974025974025974025974025974_DP, &
       0.0_DP, &
       -0.035564435564435564435564435564435564_DP, &
       0.0_DP, &
       -0.071794871794871794871794871794871795_DP, &
       0.0_DP, &
       -0.33725490196078431372549019607843137_DP, &
       0.0_DP, &
       0.99690402476780185758513931888544892_DP, &
       0.0_DP, &
       -0.33583959899749373433583959899749373_DP, &
       0.0_DP, &
       -0.068737060041407867494824016563146998_DP, &
       0.0_DP, &
       -0.030310559006211180124223602484472050_DP, &
       0.0_DP, &
       -0.017354497354497354497354497354497354_DP, &
       0.0_DP, &
       -0.011378149309183791942412632067804482_DP, &
       0.0_DP, &
       -0.0081053540452873044641676454802150019_DP, &
       0.0_DP, &
       -0.0061057222347544928190089480412061057_DP, &
       0.0_DP, &
       -0.0047873694932518461930226636108989050_DP, &
       0.0_DP, &
       -0.0038681760043989146156328818867518558_DP, &
       0.0_DP, &
       -0.0031992663571610940031992663571610940_DP, &
       0.0_DP, &
       -0.0026957842440345091458559114974809567_DP, &
       0.0_DP, &
       -0.0023063454092579348442624972255789292_DP, &
       0.0_DP, &
       -0.0019982773471145564168819982773471146_DP, &
       0.0_DP, &
       -0.0017499524469443765115078394608842151_DP, &
       0.0_DP, &
       -0.0015465632919676757645997361858619386_DP, &
       -0.020202020202020202020202020202020202_DP, &
       0.0_DP, &
       -0.022866022866022866022866022866022866_DP, &
       0.0_DP, &
       -0.033699633699633699633699633699633700_DP, &
       0.0_DP, &
       -0.070588235294117647058823529411764706_DP, &
       0.0_DP, &
       -0.33642930856553147574819401444788442_DP, &
       0.0_DP, &
       0.99749373433583959899749373433583960_DP, &
       0.0_DP, &
       -0.33540372670807453416149068322981366_DP, &
       0.0_DP, &
       -0.068405797101449275362318840579710145_DP, &
       0.0_DP, &
       -0.030052910052910052910052910052910053_DP, &
       0.0_DP, &
       -0.017150155081189563948184637839810254_DP, &
       0.0_DP, &
       -0.011213357153290412467275648588218110_DP, &
       0.0_DP, &
       -0.0079705240995563576208737499060079705_DP, &
       0.0_DP, &
       -0.0059940059940059940059940059940059940_DP, &
       0.0_DP, &
       -0.0046937693996517525929290635172988114_DP, &
       0.0_DP, &
       -0.0037889759251988354155536818075517766_DP, &
       0.0_DP, &
       -0.0031316565334537093202048272651610264_DP, &
       0.0_DP, &
       -0.0026376083492165269767676732090157822_DP, &
       0.0_DP, &
       -0.0022559263004156836310526907089091113_DP, &
       0.0_DP, &
       -0.0019542947202521670606776989755713160_DP, &
       0.0_DP, &
       -0.0017113554478610552397367196654483102_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.017094017094017094017094017094017094_DP, &
       0.0_DP, &
       -0.021001221001221001221001221001221001_DP, &
       0.0_DP, &
       -0.032492997198879551820728291316526611_DP, &
       0.0_DP, &
       -0.069762641898864809081527347781217750_DP, &
       0.0_DP, &
       -0.33583959899749373433583959899749373_DP, &
       0.0_DP, &
       0.99792960662525879917184265010351967_DP, &
       0.0_DP, &
       -0.33507246376811594202898550724637681_DP, &
       0.0_DP, &
       -0.068148148148148148148148148148148148_DP, &
       0.0_DP, &
       -0.029848567779602262360883050538222952_DP, &
       0.0_DP, &
       -0.016985362925296184473047654360223882_DP, &
       0.0_DP, &
       -0.011078527207559465623981753014011079_DP, &
       0.0_DP, &
       -0.0078588078588078588078588078588078588_DP, &
       0.0_DP, &
       -0.0059004059004059004059004059004059004_DP, &
       0.0_DP, &
       -0.0046145693204516733928498634380987322_DP, &
       0.0_DP, &
       -0.0037213661014914507325592427155517090_DP, &
       0.0_DP, &
       -0.0030734806386357271511165889766958519_DP, &
       0.0_DP, &
       -0.0025871892403742757635578666923459643_DP, &
       0.0_DP, &
       -0.0022119436735532942748483914071333128_DP, &
       0.0_DP, &
       -0.0019156977211688457889065791801354111_DP, &
       0.0_DP, &
       -0.0016772992721993011764092610224166295_DP, &
       -0.013986013986013986013986013986013986_DP, &
       0.0_DP, &
       -0.015229215229215229215229215229215229_DP, &
       0.0_DP, &
       -0.019794584500466853408029878618113912_DP, &
       0.0_DP, &
       -0.031667403803626713843432109685979655_DP, &
       0.0_DP, &
       -0.069172932330827067669172932330827068_DP, &
       0.0_DP, &
       -0.33540372670807453416149068322981366_DP, &
       0.0_DP, &
       0.99826086956521739130434782608695652_DP, &
       0.0_DP, &
       -0.33481481481481481481481481481481481_DP, &
       0.0_DP, &
       -0.067943805874840357598978288633461047_DP, &
       0.0_DP, &
       -0.029683775623708882885746067058636580_DP, &
       0.0_DP, &
       -0.016850532979565237629753758786016851_DP, &
       0.0_DP, &
       -0.010966810966810966810966810966810967_DP, &
       0.0_DP, &
       -0.0077652077652077652077652077652077652_DP, &
       0.0_DP, &
       -0.0058212058212058212058212058212058212_DP, &
       0.0_DP, &
       -0.0045469594967442887098554243460986646_DP, &
       0.0_DP, &
       -0.0036631902066734685634710044270865345_DP, &
       0.0_DP, &
       -0.0030230615297934759379067824600260341_DP, &
       0.0_DP, &
       -0.0025432066135118864073535673905701658_DP, &
       0.0_DP, &
       -0.0021733466744699730030772716116974079_DP, &
       0.0_DP, &
       -0.0018816415455070917255791205371037304_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.012121212121212121212121212121212121_DP, &
       0.0_DP, &
       -0.014022578728461081402257872846108140_DP, &
       0.0_DP, &
       -0.018968991105214015430733696987566957_DP, &
       0.0_DP, &
       -0.031077694235588972431077694235588972_DP, &
       0.0_DP, &
       -0.068737060041407867494824016563146998_DP, &
       0.0_DP, &
       -0.33507246376811594202898550724637681_DP, &
       0.0_DP, &
       0.99851851851851851851851851851851852_DP, &
       0.0_DP, &
       -0.33461047254150702426564495530012771_DP, &
       0.0_DP, &
       -0.067779013718946978123841305153874676_DP, &
       0.0_DP, &
       -0.029548945677977936042452171484429549_DP, &
       0.0_DP, &
       -0.016738816738816738816738816738816739_DP, &
       0.0_DP, &
       -0.010873210873210873210873210873210873_DP, &
       0.0_DP, &
       -0.0076860076860076860076860076860076860_DP, &
       0.0_DP, &
       -0.0057535959974984365228267667292057536_DP, &
       0.0_DP, &
       -0.0044887836019263065407671860576334902_DP, &
       0.0_DP, &
       -0.0036127710978312173502611979104167167_DP, &
       0.0_DP, &
       -0.0029790789029310865817024831582502355_DP, &
       0.0_DP, &
       -0.0025046096144285651355824475951342609_DP, &
       0.0_DP, &
       -0.0021392904988082189397498129686657272_DP, &
       0.0_DP, &
       -0.0018514407859579890656472232498869569_DP, &
       -0.010256410256410256410256410256410256_DP, &
       0.0_DP, &
       -0.010914575620457973399149869738105032_DP, &
       0.0_DP, &
       -0.013196985333208243424961691215561185_DP, &
       0.0_DP, &
       -0.018379281537176274018379281537176274_DP, &
       0.0_DP, &
       -0.030641821946169772256728778467908903_DP, &
       0.0_DP, &
       -0.068405797101449275362318840579710145_DP, &
       0.0_DP, &
       -0.33481481481481481481481481481481481_DP, &
       0.0_DP, &
       0.99872286079182630906768837803320562_DP, &
       0.0_DP, &
       -0.33444568038561364479050797182054134_DP, &
       0.0_DP, &
       -0.067644183773216031280547409579667644_DP, &
       0.0_DP, &
       -0.029437229437229437229437229437229437_DP, &
       0.0_DP, &
       -0.016645216645216645216645216645216645_DP, &
       0.0_DP, &
       -0.010794010794010794010794010794010794_DP, &
       0.0_DP, &
       -0.0076183978623003013246915685940076184_DP, &
       0.0_DP, &
       -0.0056954201026804543537385284407405791_DP, &
       0.0_DP, &
       -0.0044383644930840553275573795409636723_DP, &
       0.0_DP, &
       -0.0035687884709688279940568986086409181_DP, &
       0.0_DP, &
       -0.0029404819038477653099313633628143307_DP, &
       0.0_DP, &
       -0.0024705534387668110722549889521025802_DP, &
       0.0_DP, &
       -0.0021090897392591162798179156814489537_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0090497737556561085972850678733031674_DP, &
       0.0_DP, &
       -0.010088982225205135421853688107558077_DP, &
       0.0_DP, &
       -0.012607275765170502012607275765170502_DP, &
       0.0_DP, &
       -0.017943409247757073844030365769496204_DP, &
       0.0_DP, &
       -0.030310559006211180124223602484472050_DP, &
       0.0_DP, &
       -0.068148148148148148148148148148148148_DP, &
       0.0_DP, &
       -0.33461047254150702426564495530012771_DP, &
       0.0_DP, &
       0.99888765294771968854282536151279199_DP, &
       0.0_DP, &
       -0.33431085043988269794721407624633431_DP, &
       0.0_DP, &
       -0.067532467532467532467532467532467532_DP, &
       0.0_DP, &
       -0.029343629343629343629343629343629344_DP, &
       0.0_DP, &
       -0.016566016566016566016566016566016566_DP, &
       0.0_DP, &
       -0.010726400970303409327799571702010726_DP, &
       0.0_DP, &
       -0.0075602219674823191556033303055424439_DP, &
       0.0_DP, &
       -0.0056450009938382031405287219240707613_DP, &
       0.0_DP, &
       -0.0043943818662216659713530802391878737_DP, &
       0.0_DP, &
       -0.0035301914718855067222857788132050132_DP, &
       0.0_DP, &
       -0.0029064257281860112466039047197826499_DP, &
       0.0_DP, &
       -0.0024403526792177084123230916648858067_DP, &
       0.0_DP, &
       -0.0020821836080244611827876799164740100_DP, &
       -0.0078431372549019607843137254901960784_DP, &
       0.0_DP, &
       -0.0082241803604032706199888862427562118_DP, &
       0.0_DP, &
       -0.0094992726571673940094992726571673940_DP, &
       0.0_DP, &
       -0.012171403475751301838258359997490432_DP, &
       0.0_DP, &
       -0.017612146307798481711525189786059351_DP, &
       0.0_DP, &
       -0.030052910052910052910052910052910053_DP, &
       0.0_DP, &
       -0.067943805874840357598978288633461047_DP, &
       0.0_DP, &
       -0.33444568038561364479050797182054134_DP, &
       0.0_DP, &
       0.99902248289345063538611925708699902_DP, &
       0.0_DP, &
       -0.33419913419913419913419913419913420_DP, &
       0.0_DP, &
       -0.067438867438867438867438867438867439_DP, &
       0.0_DP, &
       -0.029264429264429264429264429264429264_DP, &
       0.0_DP, &
       -0.016498406742309181333571577474016498_DP, &
       0.0_DP, &
       -0.010668225075485427158711333413545552_DP, &
       0.0_DP, &
       -0.0075098028586400679423935237888726261_DP, &
       0.0_DP, &
       -0.0056010183669758137843244226222949627_DP, &
       0.0_DP, &
       -0.0043557848671383446995819604437519689_DP, &
       0.0_DP, &
       -0.0034961352962237526589583201701733325_DP, &
       0.0_DP, &
       -0.0028762249686369085866720074325658764_DP, &
       0.0_DP, &
       -0.0024134465479830533152928558999108630_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0070175438596491228070175438596491228_DP, &
       0.0_DP, &
       -0.0076344707923655292076344707923655292_DP, &
       0.0_DP, &
       -0.0090634003677481938351503568894873243_DP, &
       0.0_DP, &
       -0.011840140535792709705753184014053579_DP, &
       0.0_DP, &
       -0.017354497354497354497354497354497354_DP, &
       0.0_DP, &
       -0.029848567779602262360883050538222952_DP, &
       0.0_DP, &
       -0.067779013718946978123841305153874676_DP, &
       0.0_DP, &
       -0.33431085043988269794721407624633431_DP, &
       0.0_DP, &
       0.99913419913419913419913419913419913_DP, &
       0.0_DP, &
       -0.33410553410553410553410553410553411_DP, &
       0.0_DP, &
       -0.067359667359667359667359667359667360_DP, &
       0.0_DP, &
       -0.029196819440721879746269990172429197_DP, &
       0.0_DP, &
       -0.016440230847491199164483339185551324_DP, &
       0.0_DP, &
       -0.010617805966643175945501526896875734_DP, &
       0.0_DP, &
       -0.0074658202317776785861892244870968275_DP, &
       0.0_DP, &
       -0.0055624213678924925125533028268590579_DP, &
       0.0_DP, &
       -0.0043217286914765906362545018007202881_DP, &
       0.0_DP, &
       -0.0034659345366746499990264228829565590_DP, &
       0.0_DP, &
       -0.0028493188374022534896417716675909327_DP, &
       0.0_DP, &
       -0.0023893726410888882284763291628280187_DP, &
       -0.0061919504643962848297213622291021672_DP, &
       0.0_DP, &
       -0.0064278342916113813946631284092584402_DP, &
       0.0_DP, &
       -0.0071985985029463290332855550246854595_DP, &
       0.0_DP, &
       -0.0087321374277896017026451809060504713_DP, &
       0.0_DP, &
       -0.011582491582491582491582491582491582_DP, &
       0.0_DP, &
       -0.017150155081189563948184637839810254_DP, &
       0.0_DP, &
       -0.029683775623708882885746067058636580_DP, &
       0.0_DP, &
       -0.067644183773216031280547409579667644_DP, &
       0.0_DP, &
       -0.33419913419913419913419913419913420_DP, &
       0.0_DP, &
       0.99922779922779922779922779922779923_DP, &
       0.0_DP, &
       -0.33402633402633402633402633402633403_DP, &
       0.0_DP, &
       -0.067292057535959974984365228267667292_DP, &
       0.0_DP, &
       -0.029138643545903897577181751883964022_DP, &
       0.0_DP, &
       -0.016389811738648947951273532668881506_DP, &
       0.0_DP, &
       -0.010573823339780786589297227595099936_DP, &
       0.0_DP, &
       -0.0074272232326943573144181046916609227_DP, &
       0.0_DP, &
       -0.0055283651922307384492258441838273771_DP, &
       0.0_DP, &
       -0.0042915279319274879763226045135035146_DP, &
       0.0_DP, &
       -0.0034390284054399949019961871179816153_DP, &
       0.0_DP, &
       -0.0028252449305080884028252449305080884_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0056022408963585434173669467787114846_DP, &
       0.0_DP, &
       -0.0059919620021921812203142126415783705_DP, &
       0.0_DP, &
       -0.0068673355629877369007803790412486065_DP, &
       0.0_DP, &
       -0.0084744884744884744884744884744884745_DP, &
       0.0_DP, &
       -0.011378149309183791942412632067804482_DP, &
       0.0_DP, &
       -0.016985362925296184473047654360223882_DP, &
       0.0_DP, &
       -0.029548945677977936042452171484429549_DP, &
       0.0_DP, &
       -0.067532467532467532467532467532467532_DP, &
       0.0_DP, &
       -0.33410553410553410553410553410553411_DP, &
       0.0_DP, &
       0.99930699930699930699930699930699931_DP, &
       0.0_DP, &
       -0.33395872420262664165103189493433396_DP, &
       0.0_DP, &
       -0.067233881641141992815276989979202118_DP, &
       0.0_DP, &
       -0.029088224437061646363971945367294205_DP, &
       0.0_DP, &
       -0.016345829111786558595069233367105708_DP, &
       0.0_DP, &
       -0.010535226340697465317526107799664031_DP, &
       0.0_DP, &
       -0.0073931670570326032510906460486292419_DP, &
       0.0_DP, &
       -0.0054981644326816357892939468966106036_DP, &
       0.0_DP, &
       -0.0042646218006928328792923687485285709_DP, &
       0.0_DP, &
       -0.0034149544985458298151796603808987710_DP, &
       0.0_DP, &
       -0.0028036192175353638333120937938065503_DP, &
       -0.0050125313283208020050125313283208020_DP, &
       0.0_DP, &
       -0.0051663686069393432430180310110314149_DP, &
       0.0_DP, &
       -0.0056606990622335890878090366581415175_DP, &
       0.0_DP, &
       -0.0066096866096866096866096866096866097_DP, &
       0.0_DP, &
       -0.0082701462011806839393046289598013736_DP, &
       0.0_DP, &
       -0.011213357153290412467275648588218110_DP, &
       0.0_DP, &
       -0.016850532979565237629753758786016851_DP, &
       0.0_DP, &
       -0.029437229437229437229437229437229437_DP, &
       0.0_DP, &
       -0.067438867438867438867438867438867439_DP, &
       0.0_DP, &
       -0.33402633402633402633402633402633403_DP, &
       0.0_DP, &
       0.99937460913070669168230143839899937_DP, &
       0.0_DP, &
       -0.33390054830780865948194365664586878_DP, &
       0.0_DP, &
       -0.067183462532299741602067183462532300_DP, &
       0.0_DP, &
       -0.029044241810199257007767646065518406_DP, &
       0.0_DP, &
       -0.016307232112703237323298113571669803_DP, &
       0.0_DP, &
       -0.010501170165035711254198649156632350_DP, &
       0.0_DP, &
       -0.0073629662974835005911587487614124684_DP, &
       0.0_DP, &
       -0.0054712583014469806922637111316356599_DP, &
       0.0_DP, &
       -0.0042405478937986677924758420114457266_DP, &
       0.0_DP, &
       -0.0033933287855731052456665092441972329_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0045766590389016018306636155606407323_DP, &
       0.0_DP, &
       -0.0048351056669807511105128550275945619_DP, &
       0.0_DP, &
       -0.0054030501089324618736383442265795207_DP, &
       0.0_DP, &
       -0.0064053443363788191374398270949995088_DP, &
       0.0_DP, &
       -0.0081053540452873044641676454802150019_DP, &
       0.0_DP, &
       -0.011078527207559465623981753014011079_DP, &
       0.0_DP, &
       -0.016738816738816738816738816738816739_DP, &
       0.0_DP, &
       -0.029343629343629343629343629343629344_DP, &
       0.0_DP, &
       -0.067359667359667359667359667359667360_DP, &
       0.0_DP, &
       -0.33395872420262664165103189493433396_DP, &
       0.0_DP, &
       0.99943278502552467385138967668746455_DP, &
       0.0_DP, &
       -0.33385012919896640826873385012919897_DP, &
       0.0_DP, &
       -0.067139479905437352245862884160756501_DP, &
       0.0_DP, &
       -0.029005644811115935735996526270082501_DP, &
       0.0_DP, &
       -0.016273175937041483259970654928638122_DP, &
       0.0_DP, &
       -0.010470969405486608594266751869415576_DP, &
       0.0_DP, &
       -0.0073360601662488454941285129964375247_DP, &
       0.0_DP, &
       -0.0054471843945528156054471843945528156_DP, &
       0.0_DP, &
       -0.0042189221808259432229626908747441885_DP, &
       0.0_DP, &
       -0.0033738301919091732567612090389745345_DP, &
       -0.0041407867494824016563146997929606625_DP, &
       0.0_DP, &
       -0.0042453960989430096981584395772038793_DP, &
       0.0_DP, &
       -0.0045774567136796238963421625960325651_DP, &
       0.0_DP, &
       -0.0051987078356246713244684847118924198_DP, &
       0.0_DP, &
       -0.0062405521804854396623028436154131371_DP, &
       0.0_DP, &
       -0.0079705240995563576208737499060079705_DP, &
       0.0_DP, &
       -0.010966810966810966810966810966810967_DP, &
       0.0_DP, &
       -0.016645216645216645216645216645216645_DP, &
       0.0_DP, &
       -0.029264429264429264429264429264429264_DP, &
       0.0_DP, &
       -0.067292057535959974984365228267667292_DP, &
       0.0_DP, &
       -0.33390054830780865948194365664586878_DP, &
       0.0_DP, &
       0.99948320413436692506459948320413437_DP, &
       0.0_DP, &
       -0.33380614657210401891252955082742317_DP, &
       0.0_DP, &
       -0.067100882906354030974091764365320596_DP, &
       0.0_DP, &
       -0.028971588635454181672669067627050820_DP, &
       0.0_DP, &
       -0.016242975177492380600038757641421348_DP, &
       0.0_DP, &
       -0.010444063274251953497236516104440633_DP, &
       0.0_DP, &
       -0.0073119862593546804073119862593546804_DP, &
       0.0_DP, &
       -0.0054255586815800910359340332578512775_DP, &
       0.0_DP, &
       -0.0041994235871620112340573906695214902_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0038095238095238095238095238095238095_DP, &
       0.0_DP, &
       -0.0039877471456418824839877471456418825_DP, &
       0.0_DP, &
       -0.0043731144403718333471723030813454642_DP, &
       0.0_DP, &
       -0.0050339156797312918493315012323060481_DP, &
       0.0_DP, &
       -0.0061057222347544928190089480412061057_DP, &
       0.0_DP, &
       -0.0078588078588078588078588078588078588_DP, &
       0.0_DP, &
       -0.010873210873210873210873210873210873_DP, &
       0.0_DP, &
       -0.016566016566016566016566016566016566_DP, &
       0.0_DP, &
       -0.029196819440721879746269990172429197_DP, &
       0.0_DP, &
       -0.067233881641141992815276989979202118_DP, &
       0.0_DP, &
       -0.33385012919896640826873385012919897_DP, &
       0.0_DP, &
       0.99952718676122931442080378250591017_DP, &
       0.0_DP, &
       -0.33376754957302069764075843103198726_DP, &
       0.0_DP, &
       -0.067066826730692276910764305722288916_DP, &
       0.0_DP, &
       -0.028941387875905079012737170339834047_DP, &
       0.0_DP, &
       -0.016216069046257725503008521876446405_DP, &
       0.0_DP, &
       -0.010419989367357788410419989367357788_DP, &
       0.0_DP, &
       -0.0072903605463819558377988351226531423_DP, &
       0.0_DP, &
       -0.0054060600879161590470287330526285792_DP, &
       0.0_DP, &
       -0.0041817820024184537202859285790819060_DP, &
       -0.0034782608695652173913043478260869565_DP, &
       0.0_DP, &
       -0.0035518748562226823096388313779618127_DP, &
       0.0_DP, &
       -0.0037834048723340919348178876309547816_DP, &
       0.0_DP, &
       -0.0042083222844784538720353196017590925_DP, &
       0.0_DP, &
       -0.0048990857340003450060376056580990167_DP, &
       0.0_DP, &
       -0.0059940059940059940059940059940059940_DP, &
       0.0_DP, &
       -0.0077652077652077652077652077652077652_DP, &
       0.0_DP, &
       -0.010794010794010794010794010794010794_DP, &
       0.0_DP, &
       -0.016498406742309181333571577474016498_DP, &
       0.0_DP, &
       -0.029138643545903897577181751883964022_DP, &
       0.0_DP, &
       -0.067183462532299741602067183462532300_DP, &
       0.0_DP, &
       -0.33380614657210401891252955082742317_DP, &
       0.0_DP, &
       0.99956578376031263569257490230134607_DP, &
       0.0_DP, &
       -0.33373349339735894357743097238895558_DP, &
       0.0_DP, &
       -0.067036625971143174250832408435072142_DP, &
       0.0_DP, &
       -0.028914481744670423915706934574859103_DP, &
       0.0_DP, &
       -0.016191995139363560416191995139363560_DP, &
       0.0_DP, &
       -0.010398363654385063840906838230656250_DP, &
       0.0_DP, &
       -0.0072708619527180238488935349174304440_DP, &
       0.0_DP, &
       -0.0053884185031726015332572709621889950_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0032206119162640901771336553945249597_DP, &
       0.0_DP, &
       -0.0033475325829148917604689718632747119_DP, &
       0.0_DP, &
       -0.0036186127164407124596809041513684099_DP, &
       0.0_DP, &
       -0.0040734923387475070287414240275520611_DP, &
       0.0_DP, &
       -0.0047873694932518461930226636108989050_DP, &
       0.0_DP, &
       -0.0059004059004059004059004059004059004_DP, &
       0.0_DP, &
       -0.0076860076860076860076860076860076860_DP, &
       0.0_DP, &
       -0.010726400970303409327799571702010726_DP, &
       0.0_DP, &
       -0.016440230847491199164483339185551324_DP, &
       0.0_DP, &
       -0.029088224437061646363971945367294205_DP, &
       0.0_DP, &
       -0.067139479905437352245862884160756501_DP, &
       0.0_DP, &
       -0.33376754957302069764075843103198726_DP, &
       0.0_DP, &
       0.99959983993597438975590236094437775_DP, &
       0.0_DP, &
       -0.33370329263780984091749907510173881_DP, &
       0.0_DP, &
       -0.067009719839908519153802172670097198_DP, &
       0.0_DP, &
       -0.028890407837776258828890407837776259_DP, &
       0.0_DP, &
       -0.016170369426390835846678844002662022_DP, &
       0.0_DP, &
       -0.010378865060721131852001538025433552_DP, &
       0.0_DP, &
       -0.0072532203679744663351220728269908598_DP, &
       0.0_DP, &
       -0.0053724053724053724053724053724053724_DP, &
       -0.0029629629629629629629629629629629630_DP, &
       0.0_DP, &
       -0.0030162696429562996279637958798378588_DP, &
       0.0_DP, &
       -0.0031827404270215122853319883836883402_DP, &
       0.0_DP, &
       -0.0034837827707097656163870085771613785_DP, &
       0.0_DP, &
       -0.0039617760979990082157264819803519494_DP, &
       0.0_DP, &
       -0.0046937693996517525929290635172988114_DP, &
       0.0_DP, &
       -0.0058212058212058212058212058212058212_DP, &
       0.0_DP, &
       -0.0076183978623003013246915685940076184_DP, &
       0.0_DP, &
       -0.010668225075485427158711333413545552_DP, &
       0.0_DP, &
       -0.016389811738648947951273532668881506_DP, &
       0.0_DP, &
       -0.029044241810199257007767646065518406_DP, &
       0.0_DP, &
       -0.067100882906354030974091764365320596_DP, &
       0.0_DP, &
       -0.33373349339735894357743097238895558_DP, &
       0.0_DP, &
       0.99963004069552349241583425823159452_DP, &
       0.0_DP, &
       -0.33367638650657518582046883933676387_DP, &
       0.0_DP, &
       -0.066985645933014354066985645933014354_DP, &
       0.0_DP, &
       -0.028868782124803534259377256701074721_DP, &
       0.0_DP, &
       -0.016150870832726903857773543797439324_DP, &
       0.0_DP, &
       -0.010361223475977574338230075934993968_DP, &
       0.0_DP, &
       -0.0072372072372072372072372072372072372_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0027586206896551724137931034482758621_DP, &
       0.0_DP, &
       -0.0028514774870629201528268124002514872_DP, &
       0.0_DP, &
       -0.0030479104812905654420380928094813088_DP, &
       0.0_DP, &
       -0.0033720665299612668033720665299612668_DP, &
       0.0_DP, &
       -0.0038681760043989146156328818867518558_DP, &
       0.0_DP, &
       -0.0046145693204516733928498634380987322_DP, &
       0.0_DP, &
       -0.0057535959974984365228267667292057536_DP, &
       0.0_DP, &
       -0.0075602219674823191556033303055424439_DP, &
       0.0_DP, &
       -0.010617805966643175945501526896875734_DP, &
       0.0_DP, &
       -0.016345829111786558595069233367105708_DP, &
       0.0_DP, &
       -0.029005644811115935735996526270082501_DP, &
       0.0_DP, &
       -0.067066826730692276910764305722288916_DP, &
       0.0_DP, &
       -0.33370329263780984091749907510173881_DP, &
       0.0_DP, &
       0.99965694682675814751286449399656947_DP, &
       0.0_DP, &
       -0.33365231259968102073365231259968102_DP, &
       0.0_DP, &
       -0.066964020220041629497472494796312816_DP, &
       0.0_DP, &
       -0.028849283531139602270471956495852022_DP, &
       0.0_DP, &
       -0.016133229247983346344002081706999740_DP, &
       0.0_DP, &
       -0.010345210345210345210345210345210345_DP, &
       0.0_DP, &
       -0.0072226281181505062102077027450161779_DP, &
       -0.0025542784163473818646232439335887612_DP, &
       0.0_DP, &
       -0.0025938285337617929386561199686894904_DP, &
       0.0_DP, &
       -0.0027166475413319733095329168260444558_DP, &
       0.0_DP, &
       -0.0029361942405420666290231507622811971_DP, &
       0.0_DP, &
       -0.0032784664363611732032784664363611732_DP, &
       0.0_DP, &
       -0.0037889759251988354155536818075517766_DP, &
       0.0_DP, &
       -0.0045469594967442887098554243460986646_DP, &
       0.0_DP, &
       -0.0056954201026804543537385284407405791_DP, &
       0.0_DP, &
       -0.0075098028586400679423935237888726261_DP, &
       0.0_DP, &
       -0.010573823339780786589297227595099936_DP, &
       0.0_DP, &
       -0.016307232112703237323298113571669803_DP, &
       0.0_DP, &
       -0.028971588635454181672669067627050820_DP, &
       0.0_DP, &
       -0.067036625971143174250832408435072142_DP, &
       0.0_DP, &
       -0.33367638650657518582046883933676387_DP, &
       0.0_DP, &
       0.99968102073365231259968102073365231_DP, &
       0.0_DP, &
       -0.33363068688670829616413916146297948_DP, &
       0.0_DP, &
       -0.066944521626377697508567194591090118_DP, &
       0.0_DP, &
       -0.028831641946396044756700494405412438_DP, &
       0.0_DP, &
       -0.016117216117216117216117216117216117_DP, &
       0.0_DP, &
       -0.010330631226153614213315705853019286_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0023894862604540023894862604540023895_DP, &
       0.0_DP, &
       -0.0024589985880308460953622243944824590_DP, &
       0.0_DP, &
       -0.0026049313005834744965179747788443441_DP, &
       0.0_DP, &
       -0.0028425941469419730289295506686811035_DP, &
       0.0_DP, &
       -0.0031992663571610940031992663571610940_DP, &
       0.0_DP, &
       -0.0037213661014914507325592427155517090_DP, &
       0.0_DP, &
       -0.0044887836019263065407671860576334902_DP, &
       0.0_DP, &
       -0.0056450009938382031405287219240707613_DP, &
       0.0_DP, &
       -0.0074658202317776785861892244870968275_DP, &
       0.0_DP, &
       -0.010535226340697465317526107799664031_DP, &
       0.0_DP, &
       -0.016273175937041483259970654928638122_DP, &
       0.0_DP, &
       -0.028941387875905079012737170339834047_DP, &
       0.0_DP, &
       -0.067009719839908519153802172670097198_DP, &
       0.0_DP, &
       -0.33365231259968102073365231259968102_DP, &
       0.0_DP, &
       0.99970264644662503716919417187035385_DP, &
       0.0_DP, &
       -0.33361118829304436417523386125775678_DP, &
       0.0_DP, &
       -0.066926880041634139994795732500650533_DP, &
       0.0_DP, &
       -0.028815628815628815628815628815628816_DP, &
       0.0_DP, &
       -0.016102636998159386219087711625025058_DP, &
       0.0_DP, &
       -0.010317319856580077216027897403627449_DP, &
       -0.0022246941045606229143492769744160178_DP, &
       0.0_DP, &
       -0.0022546563147230555461923648797953581_DP, &
       0.0_DP, &
       -0.0023472823472823472823472823472823473_DP, &
       0.0_DP, &
       -0.0025113312069833808964243746852442505_DP, &
       0.0_DP, &
       -0.0027633940677418938288503505894810243_DP, &
       0.0_DP, &
       -0.0031316565334537093202048272651610264_DP, &
       0.0_DP, &
       -0.0036631902066734685634710044270865345_DP, &
       0.0_DP, &
       -0.0044383644930840553275573795409636723_DP, &
       0.0_DP, &
       -0.0056010183669758137843244226222949627_DP, &
       0.0_DP, &
       -0.0074272232326943573144181046916609227_DP, &
       0.0_DP, &
       -0.010501170165035711254198649156632350_DP, &
       0.0_DP, &
       -0.016242975177492380600038757641421348_DP, &
       0.0_DP, &
       -0.028914481744670423915706934574859103_DP, &
       0.0_DP, &
       -0.066985645933014354066985645933014354_DP, &
       0.0_DP, &
       -0.33363068688670829616413916146297948_DP, &
       0.0_DP, &
       0.99972214504028896915809947207557655_DP, &
       0.0_DP, &
       -0.33359354670830080666146239916731720_DP, &
       0.0_DP, &
       -0.066910866910866910866910866910866911_DP, &
       0.0_DP, &
       -0.028801049696572084631786124323437756_DP, &
       0.0_DP, &
       -0.016089325628585849221799903175633221_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0020898641588296760710553814002089864_DP, &
       0.0_DP, &
       -0.0021429400739745567331774228325952464_DP, &
       0.0_DP, &
       -0.0022536822536822536822536822536822537_DP, &
       0.0_DP, &
       -0.0024321311277833016963451746060441713_DP, &
       0.0_DP, &
       -0.0026957842440345091458559114974809567_DP, &
       0.0_DP, &
       -0.0030734806386357271511165889766958519_DP, &
       0.0_DP, &
       -0.0036127710978312173502611979104167167_DP, &
       0.0_DP, &
       -0.0043943818662216659713530802391878737_DP, &
       0.0_DP, &
       -0.0055624213678924925125533028268590579_DP, &
       0.0_DP, &
       -0.0073931670570326032510906460486292419_DP, &
       0.0_DP, &
       -0.010470969405486608594266751869415576_DP, &
       0.0_DP, &
       -0.016216069046257725503008521876446405_DP, &
       0.0_DP, &
       -0.028890407837776258828890407837776259_DP, &
       0.0_DP, &
       -0.066964020220041629497472494796312816_DP, &
       0.0_DP, &
       -0.33361118829304436417523386125775678_DP, &
       0.0_DP, &
       0.99973978662503252667187093416601613_DP, &
       0.0_DP, &
       -0.33357753357753357753357753357753358_DP, &
       0.0_DP, &
       -0.066896287791810179869881362418675852_DP, &
       0.0_DP, &
       -0.028787738326998547634498315874045919_DP, &
       0.0_DP, &
       -0.016077139163483315351043458820556187_DP, &
       -0.0019550342130987292277614858260019550_DP, &
       0.0_DP, &
       -0.0019781479180811772580404393530088747_DP, &
       0.0_DP, &
       -0.0020493399803744631330838227389951528_DP, &
       0.0_DP, &
       -0.0021744821744821744821744821744821745_DP, &
       0.0_DP, &
       -0.0023645213040759170133507355140441037_DP, &
       0.0_DP, &
       -0.0026376083492165269767676732090157822_DP, &
       0.0_DP, &
       -0.0030230615297934759379067824600260341_DP, &
       0.0_DP, &
       -0.0035687884709688279940568986086409181_DP, &
       0.0_DP, &
       -0.0043557848671383446995819604437519689_DP, &
       0.0_DP, &
       -0.0055283651922307384492258441838273771_DP, &
       0.0_DP, &
       -0.0073629662974835005911587487614124684_DP, &
       0.0_DP, &
       -0.010444063274251953497236516104440633_DP, &
       0.0_DP, &
       -0.016191995139363560416191995139363560_DP, &
       0.0_DP, &
       -0.028868782124803534259377256701074721_DP, &
       0.0_DP, &
       -0.066944521626377697508567194591090118_DP, &
       0.0_DP, &
       -0.33359354670830080666146239916731720_DP, &
       0.0_DP, &
       0.99975579975579975579975579975579976_DP, &
       0.0_DP, &
       -0.33356295445847684653654802908534252_DP, &
       0.0_DP, &
       -0.066882976422236642872593553969284015_DP, &
       0.0_DP, &
       -0.028775551861896013763741871518968886_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0018433179723502304147465437788018433_DP, &
       0.0_DP, &
       -0.0018845478244810836579468392594087811_DP, &
       0.0_DP, &
       -0.0019701399011743839330046226597950736_DP, &
       0.0_DP, &
       -0.0021068723507747897991800430824821069_DP, &
       0.0_DP, &
       -0.0023063454092579348442624972255789292_DP, &
       0.0_DP, &
       -0.0025871892403742757635578666923459643_DP, &
       0.0_DP, &
       -0.0029790789029310865817024831582502355_DP, &
       0.0_DP, &
       -0.0035301914718855067222857788132050132_DP, &
       0.0_DP, &
       -0.0043217286914765906362545018007202881_DP, &
       0.0_DP, &
       -0.0054981644326816357892939468966106036_DP, &
       0.0_DP, &
       -0.0073360601662488454941285129964375247_DP, &
       0.0_DP, &
       -0.010419989367357788410419989367357788_DP, &
       0.0_DP, &
       -0.016170369426390835846678844002662022_DP, &
       0.0_DP, &
       -0.028849283531139602270471956495852022_DP, &
       0.0_DP, &
       -0.066926880041634139994795732500650533_DP, &
       0.0_DP, &
       -0.33357753357753357753357753357753358_DP, &
       0.0_DP, &
       0.99977037887485648679678530424799082_DP, &
       0.0_DP, &
       -0.33354964308890330953926022063595068_DP, &
       0.0_DP, &
       -0.066870789957134109001837109614206981_DP, &
       0.0_DP, &
       -0.028764367024062181307020203412254348_DP, &
       -0.0017316017316017316017316017316017316_DP, &
       0.0_DP, &
       -0.0017497178787501368146529436852017497_DP, &
       0.0_DP, &
       -0.0018053477452810044578676391802087019_DP, &
       0.0_DP, &
       -0.0019025300774669992500101835677950060_DP, &
       0.0_DP, &
       -0.0020486964559568076300918047940169324_DP, &
       0.0_DP, &
       -0.0022559263004156836310526907089091113_DP, &
       0.0_DP, &
       -0.0025432066135118864073535673905701658_DP, &
       0.0_DP, &
       -0.0029404819038477653099313633628143307_DP, &
       0.0_DP, &
       -0.0034961352962237526589583201701733325_DP, &
       0.0_DP, &
       -0.0042915279319274879763226045135035146_DP, &
       0.0_DP, &
       -0.0054712583014469806922637111316356599_DP, &
       0.0_DP, &
       -0.0073119862593546804073119862593546804_DP, &
       0.0_DP, &
       -0.010398363654385063840906838230656250_DP, &
       0.0_DP, &
       -0.016150870832726903857773543797439324_DP, &
       0.0_DP, &
       -0.028831641946396044756700494405412438_DP, &
       0.0_DP, &
       -0.066910866910866910866910866910866911_DP, &
       0.0_DP, &
       -0.33356295445847684653654802908534252_DP, &
       0.0_DP, &
       0.99978369024443002379407311269738265_DP, &
       0.0_DP, &
       -0.33353745662380077566850377628087365_DP, &
       0.0_DP, &
       -0.066859605119300276545115441507492443_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0016380016380016380016380016380016380_DP, &
       0.0_DP, &
       -0.0016705177995500576145737436060016705_DP, &
       0.0_DP, &
       -0.0017377379215736197748732000882086343_DP, &
       0.0_DP, &
       -0.0018443541826490170809219452793298315_DP, &
       0.0_DP, &
       -0.0019982773471145564168819982773471146_DP, &
       0.0_DP, &
       -0.0022119436735532942748483914071333128_DP, &
       0.0_DP, &
       -0.0025046096144285651355824475951342609_DP, &
       0.0_DP, &
       -0.0029064257281860112466039047197826499_DP, &
       0.0_DP, &
       -0.0034659345366746499990264228829565590_DP, &
       0.0_DP, &
       -0.0042646218006928328792923687485285709_DP, &
       0.0_DP, &
       -0.0054471843945528156054471843945528156_DP, &
       0.0_DP, &
       -0.0072903605463819558377988351226531423_DP, &
       0.0_DP, &
       -0.010378865060721131852001538025433552_DP, &
       0.0_DP, &
       -0.016133229247983346344002081706999740_DP, &
       0.0_DP, &
       -0.028815628815628815628815628815628816_DP, &
       0.0_DP, &
       -0.066896287791810179869881362418675852_DP, &
       0.0_DP, &
       -0.33354964308890330953926022063595068_DP, &
       0.0_DP, &
       0.99979587670953255766482955705245969_DP, &
       0.0_DP, &
       -0.33352627178596694321178210817415911_DP, &
       0.0_DP, &
       -0.066849315068493150684931506849315068_DP, &
       -0.0015444015444015444015444015444015444_DP, &
       0.0_DP, &
       -0.0015588015588015588015588015588015588_DP, &
       0.0_DP, &
       -0.0016029079758426729315793045140016029_DP, &
       0.0_DP, &
       -0.0016795620267556376057849617997434598_DP, &
       0.0_DP, &
       -0.0017939350738067658677121387626600137_DP, &
       0.0_DP, &
       -0.0019542947202521670606776989755713160_DP, &
       0.0_DP, &
       -0.0021733466744699730030772716116974079_DP, &
       0.0_DP, &
       -0.0024705534387668110722549889521025802_DP, &
       0.0_DP, &
       -0.0028762249686369085866720074325658764_DP, &
       0.0_DP, &
       -0.0034390284054399949019961871179816153_DP, &
       0.0_DP, &
       -0.0042405478937986677924758420114457266_DP, &
       0.0_DP, &
       -0.0054255586815800910359340332578512775_DP, &
       0.0_DP, &
       -0.0072708619527180238488935349174304440_DP, &
       0.0_DP, &
       -0.010361223475977574338230075934993968_DP, &
       0.0_DP, &
       -0.016117216117216117216117216117216117_DP, &
       0.0_DP, &
       -0.028801049696572084631786124323437756_DP, &
       0.0_DP, &
       -0.066882976422236642872593553969284015_DP, &
       0.0_DP, &
       -0.33353745662380077566850377628087365_DP, &
       0.0_DP, &
       0.99980706154736639012155122515917422_DP, &
       0.0_DP, &
       -0.33351598173515981735159817351598174_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0014652014652014652014652014652014652_DP, &
       0.0_DP, &
       -0.0014911917350941741185643624668014912_DP, &
       0.0_DP, &
       -0.0015447320810246907624910662255364285_DP, &
       0.0_DP, &
       -0.0016291429179133863925751552830736420_DP, &
       0.0_DP, &
       -0.0017499524469443765115078394608842151_DP, &
       0.0_DP, &
       -0.0019156977211688457889065791801354111_DP, &
       0.0_DP, &
       -0.0021392904988082189397498129686657272_DP, &
       0.0_DP, &
       -0.0024403526792177084123230916648858067_DP, &
       0.0_DP, &
       -0.0028493188374022534896417716675909327_DP, &
       0.0_DP, &
       -0.0034149544985458298151796603808987710_DP, &
       0.0_DP, &
       -0.0042189221808259432229626908747441885_DP, &
       0.0_DP, &
       -0.0054060600879161590470287330526285792_DP, &
       0.0_DP, &
       -0.0072532203679744663351220728269908598_DP, &
       0.0_DP, &
       -0.010345210345210345210345210345210345_DP, &
       0.0_DP, &
       -0.016102636998159386219087711625025058_DP, &
       0.0_DP, &
       -0.028787738326998547634498315874045919_DP, &
       0.0_DP, &
       -0.066870789957134109001837109614206981_DP, &
       0.0_DP, &
       -0.33352627178596694321178210817415911_DP, &
       0.0_DP, &
       0.99981735159817351598173515981735160_DP, &
       0.0_DP, &
       -0.33350649350649350649350649350649351_DP, &
       -0.0013860013860013860013860013860013860_DP, &
       0.0_DP, &
       -0.0013975916414940805184707623732013976_DP, &
       0.0_DP, &
       -0.0014330158402761919494761241783363167_DP, &
       0.0_DP, &
       -0.0014943129721824395492812597088666106_DP, &
       0.0_DP, &
       -0.0015851602910509970363708559812978434_DP, &
       0.0_DP, &
       -0.0017113554478610552397367196654483102_DP, &
       0.0_DP, &
       -0.0018816415455070917255791205371037304_DP, &
       0.0_DP, &
       -0.0021090897392591162798179156814489537_DP, &
       0.0_DP, &
       -0.0024134465479830533152928558999108630_DP, &
       0.0_DP, &
       -0.0028252449305080884028252449305080884_DP, &
       0.0_DP, &
       -0.0033933287855731052456665092441972329_DP, &
       0.0_DP, &
       -0.0041994235871620112340573906695214902_DP, &
       0.0_DP, &
       -0.0053884185031726015332572709621889950_DP, &
       0.0_DP, &
       -0.0072372072372072372072372072372072372_DP, &
       0.0_DP, &
       -0.010330631226153614213315705853019286_DP, &
       0.0_DP, &
       -0.016089325628585849221799903175633221_DP, &
       0.0_DP, &
       -0.028775551861896013763741871518968886_DP, &
       0.0_DP, &
       -0.066859605119300276545115441507492443_DP, &
       0.0_DP, &
       -0.33351598173515981735159817351598174_DP, &
       0.0_DP, &
       0.99982683982683982683982683982683983_DP, &
       0.0_DP, &
       0.0_DP, &
       -0.0013183915622940013183915622940013184_DP, &
       0.0_DP, &
       -0.0013394157466760983493825240847362231_DP, &
       0.0_DP, &
       -0.0013825967314339407362663176616664989_DP, &
       0.0_DP, &
       -0.0014503303453200501930769604070908120_DP, &
       0.0_DP, &
       -0.0015465632919676757645997361858619386_DP, &
       0.0_DP, &
       -0.0016772992721993011764092610224166295_DP, &
       0.0_DP, &
       -0.0018514407859579890656472232498869569_DP, &
       0.0_DP, &
       -0.0020821836080244611827876799164740100_DP, &
       0.0_DP, &
       -0.0023893726410888882284763291628280187_DP, &
       0.0_DP, &
       -0.0028036192175353638333120937938065503_DP, &
       0.0_DP, &
       -0.0033738301919091732567612090389745345_DP, &
       0.0_DP, &
       -0.0041817820024184537202859285790819060_DP, &
       0.0_DP, &
       -0.0053724053724053724053724053724053724_DP, &
       0.0_DP, &
       -0.0072226281181505062102077027450161779_DP, &
       0.0_DP, &
       -0.010317319856580077216027897403627449_DP, &
       0.0_DP, &
       -0.016077139163483315351043458820556187_DP, &
       0.0_DP, &
       -0.028764367024062181307020203412254348_DP, &
       0.0_DP, &
       -0.066849315068493150684931506849315068_DP, &
       0.0_DP, &
       -0.33350649350649350649350649350649351_DP, &
       0.0_DP, &
       0.99983560743054413940489889856978465_DP /

contains

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_product_sphere(sph_coeffs1, sph_coeffs2, &
       sph_nodes)
    !==========================================================================!
    ! Calculates an integral of a product of two 3D Chebyshev polynomial       !
    ! expansions over a sphere.                                                !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs1 (in):     Coefficients of the expansion of the first factor in !
    !                     the product.                                         !
    !   coeffs2 (in):     Coefficients of the expansion of the second factor in!
    !                     the product.                                         !
    !   sph_nodes (in):   The nodes of the expansion.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_assert

    implicit none

    ! Arguments
    type(SPHERE_COEFFS), intent(in) :: sph_coeffs1
    type(SPHERE_COEFFS), intent(in) :: sph_coeffs2
    type(SPHERE_NODES), intent(in)  :: sph_nodes

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_integrate_product_sphere'
    integer :: n_intervals, order ! Number of intervals and order of expansion
    integer :: n_stripes          ! Number of stripes in the expansion
    integer :: yi, zi             ! Indices for Y, Z
    real(kind=DP) :: xmin, xmax ! Bounds of the interval for integration along X
    real(kind=DP) :: ymin, ymax ! Bounds of the interval for integration along Y
    real(kind=DP) :: zmin, zmax ! Bounds of the interval for integration along Z
    ! Integrals over X used to compute integral over Y
    real(kind=DP) :: integrals_x(1:sph_nodes%sph_ranges%n_stripes)
    ! Integrals over Y used to compute integral over Z
    real(kind=DP) :: integrals_y(1:sph_nodes%sph_ranges%n_stripes)
    ! Coefficients for the 1D expansions performed on the fly to compute
    ! integrals over Y and Z
    real(kind=DP) :: temp_coeffs(1:sph_nodes%sph_ranges%n_stripes)

    ! ------------------------------------------------------------------------
    call utils_trace_in(myself)

    call utils_assert(sph_coeffs1%n_intervals == sph_coeffs2%n_intervals, &
         'n_intervals not compatible between sets of coefficients')
    call utils_assert(sph_coeffs1%order == sph_coeffs2%order, &
         'order not compatible between sets of coefficients')

    n_stripes = sph_nodes%sph_ranges%n_stripes
    n_intervals = sph_coeffs1%n_intervals
    order = sph_coeffs1%order
    zmin = sph_nodes%sph_ranges%zmin
    zmax = sph_nodes%sph_ranges%zmax

    do zi = 1, n_stripes
       ymin = sph_nodes%sph_ranges%ymin(zi)
       ymax = sph_nodes%sph_ranges%ymax(zi)

       do yi = 1, n_stripes
          xmin = sph_nodes%sph_ranges%xmin(yi,zi)
          xmax = sph_nodes%sph_ranges%xmax(yi,zi)

          ! Calculate integral over X for this Z, Y
          integrals_x(yi) = &
               cheb_int_product_piecewise_1D( &
               sph_coeffs1%xcoeffs(:,yi,zi), &
               sph_coeffs2%xcoeffs(:,yi,zi), &
               xmin, xmax, n_intervals, order)

       end do

       ! Generate Chebyshev expansion for integral over Y for this Z
       call cheb_expansion_piecewise_1D(temp_coeffs, integrals_x, n_intervals, &
            order)

       ! Calculate this integral over Y for this Z
       integrals_y(zi) = &
            cheb_int_piecewise_1D(temp_coeffs, ymin, ymax, n_intervals, order)

    end do

    ! Generate Chebyshev expansion for integral over Z
    call cheb_expansion_piecewise_1D(temp_coeffs, integrals_y, n_intervals, &
         order)

    ! The integral over Z is the final result
    cheb_int_product_sphere = &
         cheb_int_piecewise_1D(temp_coeffs, zmin, zmax, n_intervals, order)

    call utils_trace_out(myself)

  end function cheb_int_product_sphere
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_product_piecewise_1D(coeffs1, coeffs2, &
       xmin, xmax, n_intervals, order)
    !==========================================================================!
    ! Calculates an integral of a product of two piecewise, 1D Chebyshev       !
    ! polynomial expansions.                                                   !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs1 (in):     Coefficients of the expansion of the first factor in !
    !                     the product.                                         !
    !   coeffs2 (in):     Coefficients of the expansion of the second factor in!
    !                     the product.                                         !
    !   xmin (in):        The beginning of the integration interval.           !
    !   xmax (in):        The end of the integration interval.                 !
    !   n_intervals (in): The number of intervals for the expansion.           !
    !   order (in):       The order of the expansion.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_assert

    implicit none

    ! Arguments
    integer, intent(in)       :: n_intervals
    integer, intent(in)       :: order
    real(kind=DP), intent(in) :: coeffs1(1:n_intervals*order)
    real(kind=DP), intent(in) :: coeffs2(1:n_intervals*order)
    real(kind=DP), intent(in) :: xmin, xmax

    ! Local variables
    integer :: i                       ! Index
    integer :: offs                    ! Index offset for current interval
    real(kind=DP) :: delta             ! Width of an interval
    real(kind=DP) :: curxmin, curxmax  ! Bounds of the current interval
    real(kind=DP) :: accum             ! Temporary
    
    !------------------------------------------------------------------------

    call utils_assert(n_intervals > 0,'n_intervals must be >0')
    call utils_assert(order > 1,'order must be >1')

    delta = (xmax - xmin)/real(n_intervals,kind=DP)
    accum = 0.0_DP
    do i=1, n_intervals
       offs = (i-1)*order
       curxmin = xmin + delta * real(i-1,kind=DP)
       curxmax = xmin + delta * real(i,kind=DP)

       accum = accum + cheb_int_product_1D(coeffs1, coeffs2, curxmin, curxmax, &
            order, offs)
    end do   

    cheb_int_product_piecewise_1D = accum

  end function cheb_int_product_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_product_1D(coeffs1, coeffs2, &
       xmin, xmax, order, offs)
    !==========================================================================!
    ! Calculates an integral of a product of two single-interval, 1D Chebyshev !
    ! polynomial expansions.                                                   !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs1 (in): Coefficients of the expansion of the first factor in the !
    !                 product. If 'offs' is ommitted, these will be indexed    !
    !                 from 1. If 'offs' is specified, the indices will be      !
    !                 shifted by 'offs'. This allows for reading data from a   !
    !                 large array easily.                                      !
    !   coeffs2 (in): As coeffs1, but for the second factor in the product.    !
    !   xmin (in):   The beginning of the integration interval.                !
    !   xmax (in):   The end of the integration interval.                      !
    !   order (in):  The order of the expansion.                               !
    !   offs (in):   OPTIONAL offset in the coeffs1 and coeffs2 arrays.        !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in)     :: coeffs1(:)
    real(kind=DP), intent(in)     :: coeffs2(:)
    real(kind=DP), intent(in)     :: xmin, xmax
    integer, intent(in)           :: order
    integer, intent(in), optional :: offs

    ! Local variables
    integer :: n, m               ! Indices
    real(kind=DP) :: half_width   ! Half of the interval width
    real(kind=DP) :: accum        ! Temporary
    integer :: local_offs         ! Copy of optional argument, or default value

    !------------------------------------------------------------------------

    half_width = 0.5_DP * (xmax-xmin)

    if(present(offs)) then
       local_offs = offs
    else
       local_offs = 0
    end if

    ! jd: Although the integrals for mod(n+m)/=0 are zero, it's not worth
    !     checking this, it's actually faster to multiply by these zeroes.
    !     And, since it's a checkerboard pattern, there is no possibility of
    !     eliding computing or storing some of the coefficients.
    accum = 0.0_DP
    do n = 1, order
       do m = 1, order
          accum = accum + coeffs1(local_offs+n) * coeffs2(local_offs+m) * &
               cheb_product_integrals(m,n)
       end do
    end do

    cheb_int_product_1D = half_width * accum

  end function cheb_int_product_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_sphere(sph_coeffs, sph_nodes)
    !==========================================================================!
    ! Calculates an integral of a 3D Chebyshev expansion over a sphere.        !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   sph_coeffs (in): The coefficients of the expansion.                    !
    !   sph_nodes (in):  The nodes of the expansion.                           !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    type(SPHERE_COEFFS), intent(in) :: sph_coeffs
    type(SPHERE_NODES), intent(in)  :: sph_nodes

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_integrate_sphere'
    integer :: n_intervals, order ! Number of intervals and order of expansion
    integer :: n_stripes          ! Number of stripes along any direction
    integer :: yi, zi             ! Indices for Y, Z
    real(kind=DP) :: xmin, xmax ! Bounds of the interval for integration along X
    real(kind=DP) :: ymin, ymax ! Bounds of the interval for integration along Y
    real(kind=DP) :: zmin, zmax ! Bounds of the interval for integration along Z
    ! Integrals over X used to compute integral over Y
    real(kind=DP) :: integrals_x(1:sph_nodes%sph_ranges%n_stripes)
    ! Integrals over Y used to compute integral over Z
    real(kind=DP) :: integrals_y(1:sph_nodes%sph_ranges%n_stripes)
    ! Coefficients for the 1D expansions performed on the fly to compute
    ! integrals over Y and Z
    real(kind=DP) :: temp_coeffs(1:sph_nodes%sph_ranges%n_stripes)

    ! ------------------------------------------------------------------------
    call utils_trace_in(myself)

    n_stripes = sph_nodes%sph_ranges%n_stripes
    n_intervals = sph_coeffs%n_intervals
    order = sph_coeffs%order
    zmin = sph_nodes%sph_ranges%zmin
    zmax = sph_nodes%sph_ranges%zmax

    do zi = 1, n_stripes
       ymin = sph_nodes%sph_ranges%ymin(zi)
       ymax = sph_nodes%sph_ranges%ymax(zi)

       do yi = 1, n_stripes
          xmin = sph_nodes%sph_ranges%xmin(yi,zi)
          xmax = sph_nodes%sph_ranges%xmax(yi,zi)

          ! Calculate integral over X for this Z, Y
          integrals_x(yi) = &
               cheb_int_piecewise_1D( &
               sph_coeffs%xcoeffs(:,yi,zi), &
               xmin, xmax, n_intervals, order)

       end do

       ! Generate Chebyshev expansion for integral over Y for this Z
       call cheb_expansion_piecewise_1D(temp_coeffs, integrals_x, &
            n_intervals, order)

       ! Calculate this integral over Y for this Z
       integrals_y(zi) = &
            cheb_int_piecewise_1D(temp_coeffs, ymin, ymax, n_intervals, order)

    end do

    ! Generate Chebyshev expansion for integral over Z
    call cheb_expansion_piecewise_1D(temp_coeffs, integrals_y, n_intervals, &
         order)

    ! The integral over Z is the final result
    cheb_int_sphere = &
         cheb_int_piecewise_1D(temp_coeffs, zmin, zmax, n_intervals, order)

    call utils_trace_out(myself)

  end function cheb_int_sphere
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_piecewise_1D(coeffs, xmin, xmax, &
       n_intervals, order)
    !==========================================================================!
    ! Calculates an integral of a piecewise, 1D Chebyshev expansion.           !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (in):      Coefficients of the expansion.                       !
    !   xmin (in):        The beginning of the integration interval.           !
    !   xmax (in):        The end of the integration interval.                 !
    !   n_intervals (in): The number of intervals for the expansion.           !
    !   order (in):       The order of the expansion.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_assert

    implicit none

    ! Arguments
    integer, intent(in)       :: n_intervals
    integer, intent(in)       :: order
    real(kind=DP), intent(in) :: coeffs(1:n_intervals*order)
    real(kind=DP), intent(in) :: xmin, xmax

    ! Local variables
    integer :: i                      ! index
    integer :: offs                   ! index offset for current interval
    real(kind=DP) :: delta            ! width of an interval
    real(kind=DP) :: curxmin, curxmax ! bounds of the current interval
    real(kind=DP) :: accum            ! temporary
    
    !------------------------------------------------------------------------

    call utils_assert(n_intervals > 0,'n_intervals must be >0')
    call utils_assert(order > 1,'order must be >1')

    delta = (xmax - xmin)/real(n_intervals,kind=DP)
    accum = 0.0_DP
    do i=1, n_intervals
       offs = (i-1)*order
       curxmin = xmin + delta * real(i-1,kind=DP)
       curxmax = xmin + delta * real(i,kind=DP)

       accum = accum + cheb_int_1D(coeffs, curxmin, curxmax, order, offs)
    end do   

    cheb_int_piecewise_1D = accum

  end function cheb_int_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_1D(coeffs, xmin, xmax, order, offs)
    !==========================================================================!
    ! Calculates an integral of a single-interval, 1D Chebyshev expansion.     !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (in): Coefficients of the expansion. If 'offs' is ommitted,     !
    !                these will be indexed from 1. If 'offs' is specified,     !
    !                the indices will be shifted by 'offs'. This allows for    !
    !                reading data from a large array easily.                   !
    !   xmin (in):   The beginning of the integration interval.                !
    !   xmax (in):   The end of the integration interval.                      !
    !   order (in):  The order of the expansion.                               !
    !   offs (in):   OPTIONAL offset in the coeffs array.                      !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in)     :: coeffs(:)
    real(kind=DP), intent(in)     :: xmin, xmax
    integer, intent(in)           :: order
    integer, intent(in), optional :: offs

    ! Local variables
    integer :: i                  ! index
    real(kind=DP) :: half_width   ! half the width of the interval
    real(kind=DP) :: accum        ! temporary
    integer :: local_offs         ! local copy of 'offs', or default if omitted

    !------------------------------------------------------------------------

    if(present(offs)) then
       local_offs = offs
    else
       local_offs = 0
    end if

    half_width = 0.5_DP * (xmax-xmin)

    ! Only every 2nd integral is nonzero, the remaining integrands are odd
    accum = 0.0_DP
    do i = 1, order, 2
       accum = accum + &
            coeffs(local_offs+i) * cheb_integrals(i)
    end do

    cheb_int_1D = half_width * accum

  end function cheb_int_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_expansion_for_sphere(sph_coeffs, sph_nodes, sph_values)
    !==========================================================================!
    ! Generates a piecewise Chebyshev polynomial expansion for a function      !
    ! defined on a sphere.                                                     !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   sph_coeffs (inout): The calculated coefficients will be returned here. !
    !                       This argument must be first allocated by passing it!
    !                       to cheb_alloc_coeffs, that's why it is (inout).    !
    !   sph_nodes (in):     The Chebyshev nodes for the sphere, obtained from  !
    !                       cheb_gen_nodes_for_sphere.                         !
    !   sph_values (in):    The values at the Chebyshev nodes.                 !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_assert

    implicit none

    ! Arguments
    type(SPHERE_COEFFS), intent(inout) :: sph_coeffs
    type(SPHERE_NODES), intent(in)     :: sph_nodes
    real(kind=DP), intent(in)          :: sph_values(:)

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_expansion_for_sphere'
    integer :: yi, zi            ! Indices for Y, Z
    integer :: n_stripes         ! Number of stripes along every direction
    real(kind=DP) :: xmin, xmax  ! Bounds of the current interval along X
    integer :: base              ! Offset into sph_values

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    call utils_assert(sph_coeffs%n_intervals /= 0 .and. sph_coeffs%order /= 0, &
         "Allocate sph_coeffs with cheb_alloc_coeffs before calling " &
         //trim(myself))

    n_stripes = sph_nodes%sph_ranges%n_stripes

    call utils_assert(n_stripes == sph_coeffs%n_intervals * sph_coeffs%order, &
         "Inconsistency in "//trim(myself))

    do zi = 1, n_stripes
       do yi = 1, n_stripes

          base = 1 + (yi-1) * n_stripes + (zi-1) * n_stripes*n_stripes

          xmin = sph_nodes%sph_ranges%xmin(yi,zi)
          xmax = sph_nodes%sph_ranges%xmax(yi,zi)

          call cheb_expansion_piecewise_1D( &
               sph_coeffs%xcoeffs(:,yi,zi), &
               sph_values, sph_coeffs%n_intervals, sph_coeffs%order, base)

       end do
    end do

    call utils_trace_out(myself)

  end subroutine cheb_expansion_for_sphere
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_expansion_piecewise_1D(coeffs, values, n_intervals, order, &
       base)
    !==========================================================================!
    ! Generates a piecewise, 1D Chebyshev polynomial expansion for a list of   !
    ! function values computed at a set of Chebyshev nodes.                    !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (out):  Here the calculated coefficients are returned.          !
    !                  The coefficients are stored as a 1D array with coeffs   !
    !                  for the first interval first, then coeffs for the second!
    !                  interval, etc. The array is always indexed from 1.      !
    !   values (in):   Values of the function to be expanded, computed at      !
    !                  Chebyshev nodes for subsequent intervals. The indices   !
    !                  are offset by 'base' (if specified), which allows the   !
    !                  values to be read from a longer array without the need  !
    !                  to create extra temporaries.                            !
    !   n_intervals (in): The number of intervals for the expansion.           !
    !   order (in):    Order of the Chebyshev expansion.                       !
    !   base (in):     OPTIONAL offset of data in 'values'. Omit if not needed.!
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use constants, only: PI
    use utils, only: utils_assert

    implicit none

    ! Arguments
    integer, intent(in)           :: n_intervals, order
    real(kind=DP), intent(out)    :: coeffs(1:n_intervals*order)
    real(kind=DP), intent(in)     :: values(:)
    integer, intent(in), optional :: base

    ! Local variables
    integer :: i                       ! Number of current interval
    integer :: offs                    ! Offset to current interval
    integer :: local_base              ! Local copy of 'base', default if absent

    !------------------------------------------------------------------------
    call utils_assert(n_intervals > 0,'n_intervals must be > 0')

    if(present(base)) then
       local_base = base
    else
       local_base = 1
    end if

    do i=1, n_intervals
       offs = (i-1)*order
       call cheb_expansion_1D(coeffs, values, order, local_base, offs)
    end do   

  end subroutine cheb_expansion_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_expansion_1D(coeffs, values, order, base, offs)
    !==========================================================================!
    ! Generates a single-interval, 1D Chebyshev polynomial expansion for a     !
    ! list of function values computed at Chebyshev nodes.                     !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (out):  Here the calculated coefficients are returned.          !
    !                  If 'offs' is omitted, they are written starting from an !
    !                  index of 1. If 'offs' is present, it is used to offset  !
    !                  the indices. This is useful when writing to a longer    !
    !                  array (e.g. with piecewise expansion).                  !
    !   values (in):   Values of the function to be expanded, computed at      !
    !                  Chebyshev nodes. This too is offset by 'offs', if this  !
    !                  is specified. This is useful when reading values from a !
    !                  longer array (e.g. wioth piecewise expansion).          !
    !                  The indices in values are also offset by 'base', if this!
    !                  is specified. This is useful when reading values from a !
    !                  longer array (e.g. a set of piecewise expansions).      !
    !   order (in):    Order of the Chebyshev expansion.                       !
    !   base (in):     OPTIONAL offset of data in 'values'. Omit if not needed.!
    !   offs (in):     OPTIONAL offset of data in 'values' and 'coeffs'.       !
    !                  Omit if not needed.                                     !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use constants, only: PI, DP

    implicit none

    ! Arguments
    integer, intent(in)           :: order
    real(kind=DP), intent(out)    :: coeffs(:)
    real(kind=DP), intent(in)     :: values(:)
    integer, intent(in), optional :: base
    integer, intent(in), optional :: offs

    ! Local variables
    integer :: i, k           ! indices
    integer :: local_base     ! } local copies of optional parameters,
    integer :: local_offs     ! } or default values if absent
    real(kind=DP) :: delta    ! KroneckerDelta_{i,0}
    real(kind=DP) :: ord      ! order as a real
    real(kind=DP) :: factor   ! temporary
    real(kind=DP) :: accum    ! temporary

    !------------------------------------------------------------------------

    if(present(base)) then
       local_base = base
    else
       local_base = 1
    end if

    if(present(offs)) then
       local_offs = offs
    else
       local_offs = 0
    end if

    ord = real(order,kind=DP)
    delta = 1.0_DP ! KroneckerDelta_{i,0}
    do i = 0, order-1
       factor = (2.0_DP - delta)/ord
       accum = 0.0_DP
       do k = 0, order-1
          accum = accum + &
               cos(i*PI*(k+0.5_DP)/ord) * values(local_base + local_offs + k)
       end do
       coeffs(local_offs + i+1) = factor * accum

       delta = 0.0_DP
    end do   

  end subroutine cheb_expansion_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_gen_nodes_for_sphere(sph_nodes, rad, n_intervals, order)
    !==========================================================================!
    ! Generates Chebyshev nodes for piecewise 3D integration over a sphere.    !
    ! The sphere is assumed to be centred at (0,0,0)                           !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   sph_nodes (out)  : A SPHERE_NODES variable holding the generated nodes.!
    !   rad (in)         : The radius of the sphere.                           !
    !   n_intervals (in) : Number of intervals along each Cartesian direction. !
    !   order (in)       : The order of Chebyshev expansion to use.            !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use constants, only: PI
    use utils, only: utils_alloc_check

    implicit none

    ! Arguments
    type(SPHERE_NODES), intent(out) :: sph_nodes
    real(kind=DP), intent(in) :: rad
    integer, intent(in) :: n_intervals
    integer, intent(in) :: order
    
    ! Local variables
    character(len=*), parameter :: myself = 'cheb_gen_nodes_for_sphere'
    
    integer :: n_stripes
    integer :: yi, zi            ! Indices for stripes in y, z
    real(kind=DP) :: xmin, xmax  ! Integration interval over X for current Y, Z
    real(kind=DP) :: ymin, ymax  ! Integration interval over Y for current Z
    real(kind=DP) :: zmin, zmax  ! Integration interval over Z (== [-rad,rad])
    real(kind=DP) :: rx, ry      ! Half the interval over X, Y, respectively
    real(kind=DP) :: y, z        ! Current Y, Z corresponding to yi, zi
    integer :: ierr

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    n_stripes = n_intervals * order

    allocate(sph_nodes%znodes(n_stripes),stat=ierr)
    call utils_alloc_check(myself,'znodes',ierr)
    allocate(sph_nodes%ynodes(n_stripes,n_stripes),stat=ierr)
    call utils_alloc_check(myself,'ynodes',ierr)
    allocate(sph_nodes%xnodes(n_stripes,n_stripes,n_stripes),stat=ierr)
    call utils_alloc_check(myself,'xnodes',ierr)
    allocate(sph_nodes%sph_ranges%ymin(n_stripes),stat=ierr)
    call utils_alloc_check(myself,'ymin',ierr)
    allocate(sph_nodes%sph_ranges%ymax(n_stripes),stat=ierr)
    call utils_alloc_check(myself,'ymax',ierr)
    allocate(sph_nodes%sph_ranges%xmin(n_stripes,n_stripes),stat=ierr)
    call utils_alloc_check(myself,'xmin',ierr)
    allocate(sph_nodes%sph_ranges%xmax(n_stripes,n_stripes),stat=ierr)
    call utils_alloc_check(myself,'xmax',ierr)

    zmin = -rad
    zmax = +rad

    sph_nodes%sph_ranges%n_stripes = n_stripes
    sph_nodes%sph_ranges%zmin = zmin
    sph_nodes%sph_ranges%zmax = zmax

    ! Generate Chebyshev nodes for distribution along Z
    call cheb_gen_nodes_piecewise_1D(sph_nodes%znodes, zmin, zmax, &
         n_intervals, order)

    do zi = 1, n_stripes
       z = sph_nodes%znodes(zi)

       ! Determine range in which Y changes for this Z
       ry = rad*rad - z*z
       if(ry < 0.0_DP) then
          ry = 0.0_DP ! handle rounding errors
       else
          ry = sqrt(ry)
       end if
       ymin = -ry
       ymax = +ry

       sph_nodes%sph_ranges%ymin(zi) = ymin
       sph_nodes%sph_ranges%ymax(zi) = ymax

       ! Generate Chebyshev nodes for distribution along Y for this Z
       call cheb_gen_nodes_piecewise_1D(sph_nodes%ynodes(:,zi), ymin, ymax, &
            n_intervals, order)

       do yi = 1, n_stripes
          y = sph_nodes%ynodes(yi,zi)

          ! Determine range in which X changes for this Z, Y
          rx = rad*rad - z*z - y*y
          if(rx < 0.0_DP) then
             rx = 0.0_DP ! handle rounding errors
          else
             rx = sqrt(rx)
          end if
          xmin = -rx
          xmax = +rx

          sph_nodes%sph_ranges%xmin(yi,zi) = xmin
          sph_nodes%sph_ranges%xmax(yi,zi) = xmax

          ! Generate Chebyshev nodes for distribution along X for this Z, Y
          call cheb_gen_nodes_piecewise_1D(sph_nodes%xnodes(:,yi,zi), &
               xmin, xmax, n_intervals, order)

       end do ! over Y
    end do ! over Z

    sph_nodes%n_points_total = n_stripes ** 3

    call utils_trace_out(myself)

  end subroutine cheb_gen_nodes_for_sphere
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_gen_nodes_piecewise_1D(nodes, xmin, xmax, n_intervals, &
       order)
    !==========================================================================!
    ! Calculalates the location of Chebyshev nodes of a given order, for       !
    ! a Chebyshev expansion in [xmin, xmax] on n_intervals intervals.          !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   nodes (out):      An array (order * n_intervals elements long) where   !
    !                     the nodes for every interval will be returned.       !
    !   xmin, xmax (in):  Define the range on which the interpolation will be  !
    !                     performed.                                           !
    !   n_intervals (in): The number of intervals.                             !
    !   order (in):       The order of Chebyshev interpolation.                !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use constants, only: PI

    implicit none

    ! Arguments
    integer, intent(in)        :: order
    integer, intent(in)        :: n_intervals
    real(kind=DP), intent(out) :: nodes(1:n_intervals*order)
    real(kind=DP), intent(in)  :: xmin, xmax

    ! Local variables
    integer :: i
    integer :: base           ! Shift inside nodes(:) for current interval
    real(kind=DP) :: delta    ! Width of one interval
    real(kind=DP) :: curxmin, curxmax ! xmin, xmax for current interval

    !------------------------------------------------------------------------
    delta = (xmax - xmin)/real(n_intervals,kind=DP)
    do i=1, n_intervals
       base = (i-1)*order
       curxmin = xmin + delta * real(i-1,kind=DP)
       curxmax = xmin + delta * real(i,kind=DP)

       call cheb_gen_nodes_1D(nodes(base+1:base+n_intervals), &
            curxmin,curxmax,order)
    end do   

  end subroutine cheb_gen_nodes_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_gen_nodes_1D(nodes, xmin, xmax, order)
    !==========================================================================!
    ! Calculalates the location of Chebyshev nodes of a given order, for       !
    ! a Chebyshev expansion in [xmin, xmax].                                   !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   nodes (out):     An array ('order' elements long) where the nodes will !
    !                    be returned.                                          !
    !   xmin, xmax (in): Define the range on which the interpolation will be   !
    !                    performed.                                            !
    !   order (in)     : The order of Chebyshev interpolation.                 !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use constants, only: PI
    use utils, only: utils_assert

    implicit none

    ! Arguments
    integer, intent(in)        :: order
    real(kind=DP), intent(out) :: nodes(1:order)
    real(kind=DP), intent(in)  :: xmin, xmax

    ! Local variables
    integer :: i

    !------------------------------------------------------------------------
    call utils_assert(order > 0 .and. order <= max_cheb_order, &
         'Invalid Chebyshev expansion order.')
    
    do i=0, order-1
       nodes(i+1) = cheb_unscale_x(cos(PI*((order-1)-i+0.5_DP)/order),xmin,xmax)
    end do   

  end subroutine cheb_gen_nodes_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_scale_x(x, xmin, xmax)
    !==========================================================================!
    ! Linear transformation of x in [xmin,xmax] to x' in [-1,1].               !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   x, xmin, xmax (in)                                                     !
    ! Returns:                                                                 !
    !   x'                                                                     !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in) :: x
    real(kind=DP), intent(in) :: xmin, xmax

    !------------------------------------------------------------------------
    cheb_scale_x = (2.0_DP*x - xmin - xmax)/(xmax - xmin)

  end function cheb_scale_x
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_unscale_x(xprime, xmin, xmax)
    !==========================================================================!
    ! Linear transformation of x' in [-1,1] to x in [xmin,xmax].               !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   xprime, xmin, xmax (in)                                                !
    ! Returns:                                                                 !
    !   x                                                                      !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in) :: xprime
    real(kind=DP), intent(in) :: xmin, xmax

    !------------------------------------------------------------------------
    cheb_unscale_x = 0.5_DP*((xprime + 1.0_DP)*xmax + (1.0_DP - xprime)*xmin)

  end function cheb_unscale_x
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_alloc_coeffs(sph_coeffs, n_intervals, order)
    !==========================================================================!
    ! Allocates the storage associated with a SPHERE_COEFFS variable, sets its !
    ! 'n_intervals' and 'order' fields.                                        !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   sph_coeffs (out): The SPHERE_COEFFS variable to allocate.              !
    !   n_intervals (in): The number of intervals corresponding to sph_coeffs. !
    !   order (in):       The Chebyshev order corresponding to sph_coeffs.     !
    ! The (in) arguments are used to determine how big the storage should be.  !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_alloc_check

    implicit none

    ! Arguments
    type(SPHERE_COEFFS), intent(out)   :: sph_coeffs
    integer, intent(in)                :: n_intervals
    integer, intent(in)                :: order

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_alloc_coeffs'
    integer :: n_stripes
    integer :: ierr

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    n_stripes = n_intervals * order

    allocate(sph_coeffs%xcoeffs(n_stripes,n_stripes,n_stripes), stat=ierr)
    call utils_alloc_check(myself,'sph_coeffs%xcoeffs',ierr)

    allocate(sph_coeffs%ycoeffs(n_stripes,n_stripes), stat=ierr)
    call utils_alloc_check(myself,'sph_coeffs%ycoeffs',ierr)

    allocate(sph_coeffs%zcoeffs(n_stripes), stat=ierr)
    call utils_alloc_check(myself,'sph_coeffs%zcoeffs',ierr)

    ! Set n_intervals, order -- this comes in handy in cheb_recv_coeffs
    sph_coeffs%n_intervals = n_intervals
    sph_coeffs%order = order

    call utils_trace_out(myself)
  end subroutine cheb_alloc_coeffs
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_dealloc_coeffs(sph_coeffs)
    !==========================================================================!
    ! Deallocates the storage associated with a SPHERE_COEFFS variable.        !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   sph_coeffs (inout): The SPHERE_COEFFS variable to deallocate.          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_dealloc_check

    implicit none

    ! Arguments
    type(SPHERE_COEFFS), intent(inout)   :: sph_coeffs

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_dealloc_coeffs'
    integer :: ierr

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    deallocate(sph_coeffs%xcoeffs, stat=ierr)
    call utils_dealloc_check(myself,'sph_coeffs%xcoeffs',ierr)

    deallocate(sph_coeffs%ycoeffs, stat=ierr)
    call utils_dealloc_check(myself,'sph_coeffs%ycoeffs',ierr)

    deallocate(sph_coeffs%zcoeffs, stat=ierr)
    call utils_dealloc_check(myself,'sph_coeffs%zcoeffs',ierr)

    call utils_trace_out(myself)
  end subroutine cheb_dealloc_coeffs
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_send_coeffs_initiate(handles, dest_node, coeffs, tag)
    !==========================================================================!
    ! Initiates a send of a SPHERE_COEFFS variable.                            !
    ! This calls comms_send for all the components of this derived type.       !
    ! The returned HANDLE_SET may then be tested for completion with           !
    ! cheb_test_completion.                                                    !
    !                                                                          !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   handles (out):   Here a set of handles is returned that can be used to !
    !                    test for the completion of the send, if necessary.    !
    !   dest_node (in):  The node to which the coefficents are to be sent.     !
    !   coeffs (in):     A SPHERE_COEFFS variable to be sent.                  !
    !   tag (in):        A tag for the communications.                         !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use comms, only: comms_send
    use utils, only: utils_assert

    implicit none

    ! Arguments
    type(HANDLE_SET), intent(out)   :: handles
    integer, intent(in)             :: dest_node
    type(SPHERE_COEFFS), intent(in) :: coeffs
    integer, intent(in)             :: tag

    ! Local variables
    integer :: n_stripes
    integer :: send_handles(1:n_variables_in_sphere_coeffs)

    !------------------------------------------------------------------------
    call utils_assert(coeffs%n_intervals > 0 .and. coeffs%order > 0, &
         'cheb_send_coeffs_initiate: &
         &Must first allocate the coeffs you''re sending.')

    n_stripes = coeffs%n_intervals * coeffs%order
    
    call comms_send(dest_node, coeffs%n_intervals, 1, &
         tag + CHEB_ELEMENT_TAG+1, send_handles(1), add_to_stack = .false.)
    call comms_send(dest_node, coeffs%order, 1, &
         tag + CHEB_ELEMENT_TAG+2, send_handles(2), add_to_stack = .false.)
    call comms_send(dest_node, coeffs%zcoeffs, n_stripes, &
         tag + CHEB_ELEMENT_TAG+3, send_handles(3), add_to_stack = .false.)
    call comms_send(dest_node, coeffs%ycoeffs, n_stripes**2, &
         tag + CHEB_ELEMENT_TAG+4, send_handles(4), add_to_stack = .false.)
    call comms_send(dest_node, coeffs%xcoeffs, n_stripes**3, &
         tag + CHEB_ELEMENT_TAG+5, send_handles(5), add_to_stack = .false.)

    handles%handles = send_handles
         
  end subroutine cheb_send_coeffs_initiate
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_recv_coeffs_initiate(handles, src_node, coeffs, tag)
    !==========================================================================!
    ! Initiates a receive of a SPHERE_COEFFS variable.                         !
    ! This calls comms_irecv for all the components of this derived type.      !
    ! The returned HANDLE_SET may then be tested for completion with           !
    ! cheb_test_completion.                                                    !
    !                                                                          !
    ! NB. This subroutine is expecting coeffs to have been allocated prior     !
    !     to the call, hence intent(inout).                                    !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   handles (out):  Here a set of handles is returned that can be used to  !
    !                   test for the completion of the receive.                !
    !   src_node (in):  The node from which the coefficents are to be received.!
    !   coeffs (inout): On input, a SPHERE_COEFFS variable allocated with      !
    !                   cheb_alloc_coeffs. On output: received coefficients.   !
    !   tag (in):       A tag for the communications.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use comms, only: comms_irecv
    use utils, only: utils_assert

    implicit none

    ! Arguments
    type(HANDLE_SET), intent(out)      :: handles
    integer, intent(in)                :: src_node
    type(SPHERE_COEFFS), intent(inout) :: coeffs
    integer, intent(in)                :: tag

    ! Local variables
    integer :: n_stripes
    integer :: recv_handles(1:n_variables_in_sphere_coeffs)

    !------------------------------------------------------------------------
    call utils_assert(coeffs%n_intervals > 0 .and. coeffs%order > 0, &
         'cheb_recv_coeffs_initiate: &
         &Must allocate the destination coeffs first.')

    n_stripes = coeffs%n_intervals * coeffs%order
    
    call comms_irecv(src_node, coeffs%n_intervals, 1, &
         tag + CHEB_ELEMENT_TAG+1, handle = recv_handles(1))
    call comms_irecv(src_node, coeffs%order, 1, &
         tag + CHEB_ELEMENT_TAG+2, handle = recv_handles(2))
    call comms_irecv(src_node, coeffs%zcoeffs, n_stripes, &
         tag + CHEB_ELEMENT_TAG+3, handle = recv_handles(3))
    call comms_irecv(src_node, coeffs%ycoeffs, n_stripes**2, &
         tag + CHEB_ELEMENT_TAG+4, handle = recv_handles(4))
    call comms_irecv(src_node, coeffs%xcoeffs, n_stripes**3, &
         tag + CHEB_ELEMENT_TAG+5, handle = recv_handles(5))

    handles%handles = recv_handles

  end subroutine cheb_recv_coeffs_initiate
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_test_completion(complete, handles)
    !==========================================================================!
    ! Checks for the completion of a receive operation initiated with          !
    ! cheb_recv_coeffs_initiate or of a send operation initiated with          !
    ! cheb_send_coeffs_initiate.                                               !
    ! This subroutine is non-blocking.                                         !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   complete (out): .true. iff the operation corresponding to 'handles'    !
    !                   completed.                                             !
    !   handles(in): identifies the operation in question -- use here what     !
    !                cheb_*_coeffs_initiate returned.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use comms, only: comms_test

    implicit none

    ! Arguments
    logical, intent(out)         :: complete
    type(HANDLE_SET), intent(in) :: handles

    ! Local variables
    logical :: ready(1:n_variables_in_sphere_coeffs)
    integer :: i

    ! ------------------------------------------------------------------------

    ready(:) = .false.
    do i = 1, n_variables_in_sphere_coeffs
       call comms_test(ready(i),handles%handles(i))
    end do

    complete = all(ready)

  end subroutine cheb_test_completion
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

end module chebyshev_rep
