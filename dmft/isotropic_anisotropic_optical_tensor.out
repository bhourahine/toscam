#!/bin/bash

namedat=`ls *.dat`
cp ${namedat} run.dat.original

sed 's/dmft_optics_x/!dmft_optics_x/g'   ${namedat} > run.dat.backup ; mv run.dat.backup ${namedat}  
sed 's/dmft_optics_y/!dmft_optics_y/g'   ${namedat} > run.dat.backup ; mv run.dat.backup ${namedat}
sed 's/dmft_optics_z/!dmft_optics_z/g'   ${namedat} > run.dat.backup ; mv run.dat.backup ${namedat}
sed 's/dmft_optics_i1/!dmft_optics_i1/g' ${namedat} > run.dat.backup ; mv run.dat.backup ${namedat}
sed 's/dmft_optics_i2/!dmft_optics_i2/g' ${namedat} > run.dat.backup ; mv run.dat.backup ${namedat}
sed 's/dmft_optics /!dmft_optics /g'     ${namedat} > run.dat.backup ; mv run.dat.backup ${namedat}

cp ${namedat} run.dat.backup

for k1 in 1 2 3
 do 
 for k2 in 1 2 3
 do 
   echo $k1 $k2
   cp run.dat.backup ${namedat}  
   echo "dmft_optics    :  T " >> ${namedat} 
   echo "dmft_optics_i1 :" $k1 >> ${namedat} 
   echo "dmft_optics_i2 :" $k2 >> ${namedat} 

#  onetep.dmft compute_dos=.true. > optical_tensor_${k1}_${k2}
   onetep.dmft.compute.dos.out    > optical_tensor_${k1}_${k2}

  #BUG corrected September 19th, 2012 : standard MPI_EXEC is now used
  #/opt/mpich2/intel/11.1/bin/mpiexec -env OMP_NUM_THREADS 1 -np 2 onetep.dmft.compute.optics.out > optical_tensor_${k1}_${k2}_read_optics
   ${DMFT_ONETEP_MPI_EXEC}                                   -np 2 onetep.dmft.compute.optics.out > optical_tensor_${k1}_${k2}_read_optics
   mv optical_conductivity_pm_vertex_1    1${k1}${k2}
   mv optical_conductivity_spin1_vertex_1 1${k1}${k2}
   mv optical_conductivity_spin1_vertex_1 2${k1}${k2}
 done
 done

 cp run.dat.original ${namedat}
 
 onetep.dmft.build.optical.tensor.out

